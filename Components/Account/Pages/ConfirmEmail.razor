@page "/Account/ConfirmEmail"

@using System.Text
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using DiarioMagna.Data

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Confirmar correo</PageTitle>

<div class="auth-page">
    <div class="auth-card fade-in">
        <div class="auth-icon">✅</div>

        <h1 class="auth-title">Correo confirmado</h1>
        <p class="auth-subtitle">
            Tu cuenta ha sido confirmada correctamente.
        </p>

        @if (!string.IsNullOrWhiteSpace(_statusMessage))
        {
            <p class="small text-muted mb-4">@_statusMessage</p>
        }

        <button type="button"
                class="btn btn-primary auth-submit w-100"
                @onclick="IrALogin">
            Ir a iniciar sesión
        </button>
    </div>
</div>

@code {
    [SupplyParameterFromQuery] public string? UserId { get; set; }
    [SupplyParameterFromQuery] public string? Code { get; set; }
    [SupplyParameterFromQuery] public string? ReturnUrl { get; set; }

    private string _statusMessage = "";

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(UserId) || string.IsNullOrWhiteSpace(Code))
        {
            _statusMessage = "Los datos de confirmación no son válidos.";
            return;
        }

        var user = await UserManager.FindByIdAsync(UserId);
        if (user is null)
        {
            _statusMessage = "No se encontró el usuario especificado.";
            return;
        }

        var decodedCode = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(Code));
        var result = await UserManager.ConfirmEmailAsync(user, decodedCode);

        _statusMessage = result.Succeeded
            ? "Tu correo ha sido confirmado. Ya puedes iniciar sesión."
            : "Ocurrió un problema al confirmar tu correo. Intenta nuevamente.";
    }

    private void IrALogin()
    {
        if (!string.IsNullOrWhiteSpace(ReturnUrl))
            RedirectManager.RedirectTo(ReturnUrl);
        else
            NavigationManager.NavigateTo("/Account/Login");
    }
}
