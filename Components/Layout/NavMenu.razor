@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation

<div class="sidebar-layout">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <i class="bi bi-newspaper"></i>
        </div>
        <div class="sidebar-title">
            <div class="text-white fw-semibold">Diario Magna</div>
            <div class="text-white-50 small">Plataforma de gestión de noticias</div>
        </div>
    </div>

    <div class="sidebar-menu">
        <nav class="nav flex-column">

            <div class="sidebar-section-caption">
                Principal
            </div>

            <NavLink class="nav-link sidebar-link" href="/" Match="NavLinkMatch.All">
                <span class="sidebar-icon">
                    <i class="bi bi-house-fill"></i>
                </span>
                <span>Inicio</span>
            </NavLink>

            @if (IsAuthenticated)
            {
                @if (IsAdmin)
                {
                    <div class="sidebar-section-caption mt-3">
                        Administración
                    </div>

                    <NavLink class="nav-link sidebar-link" href="/admin/user-roles">
                        <span class="sidebar-icon">
                            <i class="bi bi-shield-lock-fill"></i>
                        </span>
                        <span>Gestión de roles</span>
                    </NavLink>
                }

                <div class="sidebar-section-caption @(IsAdmin ? "" : "mt-3")">
                    Noticias
                </div>

                @if (IsSecretaria || IsAdmin)
                {
                    <NavLink class="nav-link sidebar-link" href="/articles/create">
                        <span class="sidebar-icon">
                            <i class="bi bi-file-earmark-plus-fill"></i>
                        </span>
                        <span>Crear artículo</span>
                    </NavLink>
                }

                @if (IsRelaciones || IsSecretaria || IsEncargado || IsAdmin)
                {
                    <NavLink class="nav-link sidebar-link" href="/mis-articulos">
                        <span class="sidebar-icon">
                            <i class="bi bi-collection-fill"></i>
                        </span>
                        <span>Mis artículos</span>
                    </NavLink>
                }

                @if (IsRelaciones || IsAdmin)
                {
                    <NavLink class="nav-link sidebar-link" href="/admin/solicitudes">
                        <span class="sidebar-icon">
                            <i class="bi bi-inboxes-fill"></i>
                        </span>
                        <span>Panel de solicitudes</span>
                    </NavLink>
                }

                @if (IsEncargado || IsAdmin)
                {
                    <NavLink class="nav-link sidebar-link" href="/admin/envios">
                        <span class="sidebar-icon">
                            <i class="bi bi-send-check-fill"></i>
                        </span>
                        <span>Panel de envíos</span>
                    </NavLink>

                    <NavLink class="nav-link sidebar-link" href="/admin/noticieros">
                        <span class="sidebar-icon">
                            <i class="bi bi-broadcast-pin"></i>
                        </span>
                        <span>Noticieros</span>
                    </NavLink>
                }
            }
        </nav>
    </div>

    <div class="sidebar-footer">
        @if (IsAuthenticated)
        {
            <div class="sidebar-user d-flex align-items-start mb-3">
                <div class="sidebar-user-icon">
                    <i class="bi bi-person-circle"></i>
                </div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">@UserName</div>
                    <div class="sidebar-user-roles">@UserRolesText</div>
                </div>
            </div>

            <form action="/app/logout" method="post">
                <AntiforgeryToken />
                <button type="submit" class="btn btn-outline-light btn-sm w-100 sidebar-logout-btn">
                    <i class="bi bi-box-arrow-right me-2"></i>
                    Cerrar sesión
                </button>
            </form>
        }
        else
        {
            <div class="d-grid gap-2">
                <NavLink class="btn btn-light btn-sm" href="/Account/Login">
                    <i class="bi bi-box-arrow-in-right me-1"></i>
                    Iniciar sesión
                </NavLink>
                <NavLink class="btn btn-outline-light btn-sm" href="/Account/Register">
                    <i class="bi bi-person-plus me-1"></i>
                    Registrarse
                </NavLink>
            </div>
        }
    </div>
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    private bool IsAuthenticated;
    private bool IsAdmin;
    private bool IsSecretaria;
    private bool IsRelaciones;
    private bool IsEncargado;
    private string UserName = "";
    private string UserRolesText = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateTask;
        var user = authState.User;

        IsAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (!IsAuthenticated)
            return;

        IsAdmin = user.IsInRole("Administrador");
        IsSecretaria = user.IsInRole("Secretaria");
        IsRelaciones = user.IsInRole("RelacionesPublicas");
        IsEncargado = user.IsInRole("EncargadoSistema");

        UserName = user.Identity?.Name ?? "";

        var roles = new List<string>();
        if (IsAdmin) roles.Add("Administrador");
        if (IsSecretaria) roles.Add("Secretaría");
        if (IsRelaciones) roles.Add("Relaciones Públicas");
        if (IsEncargado) roles.Add("Encargado del sistema");

        UserRolesText = string.Join(" · ", roles);
    }
}
