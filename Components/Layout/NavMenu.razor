@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation

<div class="sidebar-layout">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <span class="fs-4 text-white">📰</span>
        </div>
        <div class="sidebar-title">
            <div class="text-white fw-semibold">Diario Magna</div>
            <div class="text-white-50 small">Plataforma de gestión de noticias</div>
        </div>
    </div>

    <div class="sidebar-menu">
        <nav class="nav flex-column">

            <NavLink class="nav-link sidebar-link" href="/" Match="NavLinkMatch.All">
                <span class="me-2 bi bi-house-door-fill-nav-menu"></span>
                <span>Inicio</span>
            </NavLink>

            @if (IsAuthenticated)
            {
                @if (IsSecretaria || IsAdmin)
                {
                    <NavLink class="nav-link sidebar-link" href="/articles/create">
                        <span class="me-2 bi bi-file-earmark-plus"></span>
                        <span>Crear artículo</span>
                    </NavLink>
                }

                @if (IsRelaciones || IsSecretaria || IsEncargado || IsAdmin)
                {
                    <NavLink class="nav-link sidebar-link" href="/mis-articulos">
                        <span class="me-2 bi bi-journal-text"></span>
                        <span>Mis artículos</span>
                    </NavLink>
                }

                @if (IsRelaciones || IsAdmin)
                {
                    <NavLink class="nav-link sidebar-link" href="/admin/solicitudes">
                        <span class="me-2 bi bi-inboxes"></span>
                        <span>Panel de solicitudes</span>
                    </NavLink>
                }

                @if (IsEncargado || IsAdmin)
                {
                    <NavLink class="nav-link sidebar-link" href="/admin/envios">
                        <span class="me-2 bi bi-send-check"></span>
                        <span>Panel de envíos</span>
                    </NavLink>

                    <NavLink class="nav-link sidebar-link" href="/admin/noticieros">
                        <span class="me-2 bi bi-broadcast-pin"></span>
                        <span>Noticieros</span>
                    </NavLink>
                }
            }
        </nav>
    </div>

    <div class="sidebar-footer">
        @if (IsAuthenticated)
        {
            <form action="/app/logout" method="post" class="mt-2">
                <AntiforgeryToken />
                <button type="submit" class="btn btn-outline-light btn-sm w-100">
                    Cerrar sesión
                </button>
            </form>
        }
        else
        {
            <div class="d-grid gap-2">
                <NavLink class="btn btn-light btn-sm" href="/Account/Login">
                    Iniciar sesión
                </NavLink>
                <NavLink class="btn btn-outline-light btn-sm" href="/Account/Register">
                    Registrarse
                </NavLink>
            </div>
        }
    </div>
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    private bool IsAuthenticated;
    private bool IsAdmin;
    private bool IsSecretaria;
    private bool IsRelaciones;
    private bool IsEncargado;
    private string UserName = "";
    private string UserRolesText = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateTask;
        var user = authState.User;

        IsAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (!IsAuthenticated)
            return;

        IsAdmin = user.IsInRole("Administrador");
        IsSecretaria = user.IsInRole("Secretaria");
        IsRelaciones = user.IsInRole("RelacionesPublicas");
        IsEncargado = user.IsInRole("EncargadoSistema");

        UserName = user.Identity?.Name ?? "";

        var roles = new List<string>();
        if (IsAdmin) roles.Add("Administrador");
        if (IsSecretaria) roles.Add("Secretaría");
        if (IsRelaciones) roles.Add("Relaciones Públicas");
        if (IsEncargado) roles.Add("Encargado del sistema");

        UserRolesText = string.Join(" · ", roles);
    }
}
