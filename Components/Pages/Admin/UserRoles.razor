@page "/admin/user-roles"
@rendermode InteractiveServer
@attribute [Authorize(Roles = AppRoles.Administrador)]

@using DiarioMagna.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using DiarioMagna.Components.Shared

@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject ILogger<UserRoles> Logger

<PageHeader Icon="bi bi-shield-lock"
            Title="Gestión de roles y usuarios"
            Description="Crea usuarios, asigna o quita permisos a los usuarios del sistema" />

<div class="container mb-2">
    @if (_isLoading)
    {
        <div class="small text-muted">
            Cargando usuarios...
        </div>
    }
    else
    {
        <div class="small text-muted d-flex gap-3">
            <span>Usuarios: @_users.Count</span>
            <span>Roles: @_allRoleNames.Count</span>
        </div>
    }
</div>

<section class="admin-list-section">
    <div class="container">
        @if (_isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border" role="status"></div>
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <div class="alert alert-danger mt-3">
                @_errorMessage
            </div>
        }
        else
        {
            @if (!string.IsNullOrWhiteSpace(_successMessage))
            {
                <div class="alert alert-success py-2 px-3 small mt-3">
                    @_successMessage
                </div>
            }

            <!-- Card para crear nuevo usuario -->
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-2">Crear nuevo usuario</h5>
                    <p class="small text-muted mb-3">
                        Registre un usuario y asigne sus roles iniciales.
                    </p>

                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label class="form-label small mb-1">Correo electrónico</label>
                            <input class="form-control form-control-sm"
                                   @bind="_newUser.Email"
                                   placeholder="correo@ejemplo.com" />
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label small mb-1">Nombre de usuario (opcional)</label>
                            <input class="form-control form-control-sm"
                                   @bind="_newUser.UserName"
                                   placeholder="Nombre para iniciar sesión" />
                        </div>
                        <div class="col-12 col-md-2">
                            <label class="form-label small mb-1">Contraseña</label>
                            <input class="form-control form-control-sm"
                                   type="password"
                                   @bind="_newUser.Password" />
                        </div>
                        <div class="col-12 col-md-2">
                            <label class="form-label small mb-1">Confirmar</label>
                            <input class="form-control form-control-sm"
                                   type="password"
                                   @bind="_newUser.ConfirmPassword" />
                        </div>
                    </div>

                    @if (_allRoleNames.Any())
                    {
                        <div class="mt-3">
                            <div class="small fw-semibold mb-1">Roles iniciales</div>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var roleName in _allRoleNames)
                                {
                                    <div class="form-check form-check-inline envio-noticiero-chip">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="@($"newuser-role-{roleName}")"
                                               checked="@_newUser.RoleSelections.GetValueOrDefault(roleName)"
                                               @onchange="e => OnNewUserRoleChanged(roleName, (bool)e.Value!)" />
                                        <label class="form-check-label small" for="@($"newuser-role-{roleName}")">
                                            @roleName
                                        </label>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <div class="mt-3 d-flex justify-content-end">
                        <button class="btn btn-success btn-sm"
                                disabled="@_newUser.IsSaving"
                                @onclick="CreateUserAsync">
                            @if (_newUser.IsSaving)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="ms-1">Creando...</span>
                            }
                            else
                            {
                                <span class="bi bi-person-plus me-1"></span>
                                <span>Crear usuario</span>
                            }
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filtros y listado de usuarios existentes -->
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body">
                    <div class="row g-2 align-items-end">
                        <div class="col-12 col-md-6">
                            <label class="form-label small mb-1">Buscar usuario</label>
                            <input class="form-control form-control-sm"
                                   @bind="_search"
                                   placeholder="Buscar por nombre o correo..." />
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label small mb-1">Filtrar por rol</label>
                            <select class="form-select form-select-sm" @bind="_roleFilter">
                                <option value="">Todos</option>
                                @foreach (var role in _allRoleNames)
                                {
                                    <option value="@role">@role</option>
                                }
                            </select>
                        </div>
                        <div class="col-12 col-md-3 text-md-end">
                            <div class="small text-muted mt-3 mt-md-0">
                                Usuarios encontrados: @FilteredUsers.Count()
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (!FilteredUsers.Any())
            {
                <div class="alert alert-info small">
                    No se encontraron usuarios con los criterios seleccionados.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle">
                        <thead class="table-light">
                            <tr class="small">
                                <th>Usuario</th>
                                <th>Email</th>
                                @foreach (var roleName in _allRoleNames)
                                {
                                    <th class="text-center">@roleName</th>
                                }
                                <th class="text-center" style="width: 210px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in FilteredUsers)
                            {
                                <tr>
                                    <td>
                                        <div class="fw-semibold">@user.UserName</div>
                                        @if (!string.IsNullOrWhiteSpace(user.Id))
                                        {
                                            <div class="small text-muted">ID: @user.Id</div>
                                        }
                                    </td>
                                    <td>
                                        <div>@user.Email</div>
                                    </td>

                                    @foreach (var roleName in _allRoleNames)
                                    {
                                        <td class="text-center">
                                            <input type="checkbox"
                                                   checked="@user.RoleSelections.GetValueOrDefault(roleName)"
                                                   @onchange="e => OnRoleChanged(user, roleName, (bool)e.Value!)" />
                                        </td>
                                    }

                                    <td class="text-center">
                                        <div class="d-flex flex-wrap justify-content-center gap-1">
                                            <button class="btn btn-primary btn-sm"
                                                    disabled="@user.IsSaving"
                                                    @onclick="() => SaveUserRolesAsync(user)">
                                                @if (user.IsSaving)
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                    <span class="ms-1">Guardando...</span>
                                                }
                                                else
                                                {
                                                    <span class="bi bi-save me-1"></span>
                                                    <span>Guardar</span>
                                                }
                                            </button>

                                            <button class="btn btn-outline-danger btn-sm"
                                                    disabled="@user.IsSaving"
                                                    @onclick="() => DeleteUserAsync(user)">
                                                <span class="bi bi-trash me-1"></span>
                                                <span>Eliminar</span>
                                            </button>
                                        </div>

                                        @if (!string.IsNullOrWhiteSpace(user.Message))
                                        {
                                            <div class="small text-success mt-1">
                                                @user.Message
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        }
    </div>
</section>

@code {
    private List<UserWithRolesViewModel> _users = new();
    private List<string> _allRoleNames = new();

    private bool _isLoading = true;
    private string? _errorMessage;
    private string? _successMessage;

    private string _search = "";
    private string _roleFilter = "";

    private NewUserModel _newUser = new();

    private IEnumerable<UserWithRolesViewModel> FilteredUsers =>
        GetFilteredUsers();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            _successMessage = null;

            _allRoleNames = await RoleManager.Roles
                .OrderBy(r => r.Name)
                .Select(r => r.Name!)
                .ToListAsync();

            _newUser = new NewUserModel
            {
                RoleSelections = _allRoleNames.ToDictionary(r => r, _ => false)
            };

            var users = await UserManager.Users
                .OrderBy(u => u.UserName)
                .ToListAsync();

            var list = new List<UserWithRolesViewModel>();

            foreach (var u in users)
            {
                var roles = await UserManager.GetRolesAsync(u);

                var vm = new UserWithRolesViewModel
                {
                    Id = u.Id,
                    UserName = u.UserName,
                    Email = u.Email,
                    RoleSelections = _allRoleNames
                        .ToDictionary(
                            r => r,
                            r => roles.Contains(r)
                        )
                };

                list.Add(vm);
            }

            _users = list;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar usuarios y roles");
            _errorMessage = "Ocurrió un error al cargar los usuarios. Intente de nuevo.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private IEnumerable<UserWithRolesViewModel> GetFilteredUsers()
    {
        IEnumerable<UserWithRolesViewModel> query = _users;

        if (!string.IsNullOrWhiteSpace(_search))
        {
            var s = _search.Trim().ToLowerInvariant();
            query = query.Where(u =>
                (!string.IsNullOrWhiteSpace(u.UserName) && u.UserName!.ToLowerInvariant().Contains(s)) ||
                (!string.IsNullOrWhiteSpace(u.Email) && u.Email!.ToLowerInvariant().Contains(s))
            );
        }

        if (!string.IsNullOrWhiteSpace(_roleFilter))
        {
            query = query.Where(u =>
                u.RoleSelections.TryGetValue(_roleFilter, out var hasRole) && hasRole
            );
        }

        return query;
    }

    private void OnRoleChanged(UserWithRolesViewModel user, string roleName, bool isChecked)
    {
        if (!user.RoleSelections.ContainsKey(roleName))
        {
            user.RoleSelections.Add(roleName, isChecked);
        }
        else
        {
            user.RoleSelections[roleName] = isChecked;
        }

        user.Message = null;
        _successMessage = null;
    }

    private void OnNewUserRoleChanged(string roleName, bool isChecked)
    {
        if (!_newUser.RoleSelections.ContainsKey(roleName))
        {
            _newUser.RoleSelections.Add(roleName, isChecked);
        }
        else
        {
            _newUser.RoleSelections[roleName] = isChecked;
        }

        _errorMessage = null;
        _successMessage = null;
    }

    private async Task CreateUserAsync()
    {
        try
        {
            _newUser.IsSaving = true;
            _errorMessage = null;
            _successMessage = null;

            if (string.IsNullOrWhiteSpace(_newUser.Email))
            {
                _errorMessage = "El correo electrónico es obligatorio.";
                return;
            }

            if (string.IsNullOrWhiteSpace(_newUser.Password) ||
                string.IsNullOrWhiteSpace(_newUser.ConfirmPassword))
            {
                _errorMessage = "Debe especificar la contraseña y su confirmación.";
                return;
            }

            if (_newUser.Password != _newUser.ConfirmPassword)
            {
                _errorMessage = "La contraseña y la confirmación no coinciden.";
                return;
            }

            var user = new ApplicationUser
            {
                UserName = string.IsNullOrWhiteSpace(_newUser.UserName)
                    ? _newUser.Email
                    : _newUser.UserName,
                Email = _newUser.Email
            };

            var createResult = await UserManager.CreateAsync(user, _newUser.Password);
            if (!createResult.Succeeded)
            {
                _errorMessage = "Error al crear el usuario: " +
                                string.Join("; ", createResult.Errors.Select(e => e.Description));
                return;
            }

            var selectedRoles = _newUser.RoleSelections
                .Where(kv => kv.Value)
                .Select(kv => kv.Key)
                .ToList();

            if (selectedRoles.Any())
            {
                var addRolesResult = await UserManager.AddToRolesAsync(user, selectedRoles);
                if (!addRolesResult.Succeeded)
                {
                    _errorMessage = "Usuario creado, pero ocurrió un error al asignar los roles: " +
                                    string.Join("; ", addRolesResult.Errors.Select(e => e.Description));
                    return;
                }
            }

            _successMessage = $"Usuario '{user.UserName}' creado correctamente.";

            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al crear nuevo usuario");
            _errorMessage = "Ocurrió un error al crear el usuario. Revise el log o intente nuevamente.";
        }
        finally
        {
            _newUser.IsSaving = false;
        }
    }

    private async Task SaveUserRolesAsync(UserWithRolesViewModel userVm)
    {
        try
        {
            userVm.IsSaving = true;
            userVm.Message = null;
            _errorMessage = null;
            _successMessage = null;

            var user = await UserManager.FindByIdAsync(userVm.Id);
            if (user == null)
            {
                _errorMessage = "No se encontró el usuario en el sistema.";
                userVm.IsSaving = false;
                return;
            }

            var currentRoles = await UserManager.GetRolesAsync(user);
            var desiredRoles = userVm.RoleSelections
                .Where(kv => kv.Value)
                .Select(kv => kv.Key)
                .ToList();

            var rolesToAdd = desiredRoles.Except(currentRoles).ToList();
            var rolesToRemove = currentRoles.Except(desiredRoles).ToList();

            if (rolesToAdd.Any())
            {
                var addResult = await UserManager.AddToRolesAsync(user, rolesToAdd);
                if (!addResult.Succeeded)
                {
                    _errorMessage = "Ocurrió un error al agregar roles al usuario.";
                    Logger.LogError("AddToRolesAsync error: {Errors}",
                        string.Join(", ", addResult.Errors.Select(e => e.Description)));
                }
            }

            if (rolesToRemove.Any())
            {
                var removeResult = await UserManager.RemoveFromRolesAsync(user, rolesToRemove);
                if (!removeResult.Succeeded)
                {
                    _errorMessage = "Ocurrió un error al quitar roles al usuario.";
                    Logger.LogError("RemoveFromRolesAsync error: {Errors}",
                        string.Join(", ", removeResult.Errors.Select(e => e.Description)));
                }
            }

            if (string.IsNullOrWhiteSpace(_errorMessage))
            {
                userVm.Message = "Roles actualizados correctamente.";
                _successMessage = $"Roles actualizados para el usuario {userVm.UserName}.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar roles del usuario {UserId}", userVm.Id);
            _errorMessage = "Ocurrió un error al guardar los roles. Revise el log o intente nuevamente.";
        }
        finally
        {
            userVm.IsSaving = false;
        }
    }

    private async Task DeleteUserAsync(UserWithRolesViewModel userVm)
    {
        try
        {
            userVm.IsSaving = true;
            _errorMessage = null;
            _successMessage = null;

            var user = await UserManager.FindByIdAsync(userVm.Id);
            if (user == null)
            {
                _errorMessage = "No se encontró el usuario a eliminar.";
                userVm.IsSaving = false;
                return;
            }

            var deleteResult = await UserManager.DeleteAsync(user);
            if (!deleteResult.Succeeded)
            {
                _errorMessage = "Ocurrió un error al eliminar el usuario: " +
                                string.Join("; ", deleteResult.Errors.Select(e => e.Description));
                userVm.IsSaving = false;
                return;
            }

            _users.RemoveAll(u => u.Id == userVm.Id);
            _successMessage = $"Usuario '{userVm.UserName}' eliminado correctamente.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al eliminar usuario {UserId}", userVm.Id);
            _errorMessage = "Ocurrió un error al eliminar el usuario. Revise el log o intente nuevamente.";
        }
        finally
        {
            userVm.IsSaving = false;
        }
    }

    private sealed class UserWithRolesViewModel
    {
        public string Id { get; set; } = string.Empty;
        public string? UserName { get; set; }
        public string? Email { get; set; }

        public Dictionary<string, bool> RoleSelections { get; set; } = new();

        public bool IsSaving { get; set; }
        public string? Message { get; set; }
    }

    private sealed class NewUserModel
    {
        public string Email { get; set; } = string.Empty;
        public string? UserName { get; set; }
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;

        public Dictionary<string, bool> RoleSelections { get; set; } = new();

        public bool IsSaving { get; set; }
    }
}
