@page "/admin/user-roles"
@rendermode InteractiveServer
@attribute [Authorize(Roles = AppRoles.Administrador)]

@using System.ComponentModel.DataAnnotations
@using DiarioMagna.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using DiarioMagna.Components.Shared

@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject ILogger<UserRoles> Logger
@inject LayoutHeaderState HeaderState

<PageHeader Icon="bi bi-shield-lock"
            Title="Gestión de roles y usuarios"
            Description="Crea usuarios, edita datos y asigna permisos a los usuarios del sistema" />

<div class="container mb-2">
    @if (_isLoading)
    {
        <div class="card shadow-sm border-0 admin-article-card">
            <div class="card-body py-2 small text-muted">
                Cargando usuarios...
            </div>
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0 admin-article-card">
            <div class="card-body py-2 small text-muted d-flex flex-wrap gap-3">
                <span><i class="bi bi-people me-1"></i>Usuarios: @_users.Count</span>
                <span><i class="bi bi-key me-1"></i>Roles: @_allRoleNames.Count</span>
            </div>
        </div>
    }
</div>

<section class="admin-list-section">
    <div class="container">
        @if (_isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border" role="status"></div>
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <div class="alert alert-danger mt-3 admin-article-card">
                @_errorMessage
            </div>
        }
        else
        {
            @if (!string.IsNullOrWhiteSpace(_successMessage))
            {
                <div class="alert alert-success py-2 px-3 small mt-3 admin-article-card">
                    @_successMessage
                </div>
            }

            <div class="card shadow-sm border-0 mb-3 admin-article-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h5 class="card-title mb-0">Crear nuevo usuario</h5>
                        <span class="small text-muted">Módulo de identidad</span>
                    </div>
                    <p class="small text-muted mb-3">
                        Registre un usuario y asigne sus roles iniciales.
                    </p>

                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label class="form-label small mb-1">Correo electrónico</label>
                            <input class="form-control form-control-sm"
                                   @bind="_newUser.Email"
                                   placeholder="correo@ejemplo.com" />
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label small mb-1">Nombre de usuario (opcional)</label>
                            <input class="form-control form-control-sm"
                                   @bind="_newUser.UserName"
                                   placeholder="Nombre para mostrar / iniciar sesión" />
                        </div>
                        <div class="col-12 col-md-2">
                            <label class="form-label small mb-1">Contraseña</label>
                            <input class="form-control form-control-sm"
                                   type="password"
                                   @bind="_newUser.Password" />
                        </div>
                        <div class="col-12 col-md-2">
                            <label class="form-label small mb-1">Confirmar</label>
                            <input class="form-control form-control-sm"
                                   type="password"
                                   @bind="_newUser.ConfirmPassword" />
                        </div>
                    </div>

                    @if (_allRoleNames.Any())
                    {
                        <div class="mt-3">
                            <div class="small fw-semibold mb-1">Roles iniciales</div>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var roleName in _allRoleNames)
                                {
                                    <div class="form-check form-check-inline envio-noticiero-chip">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="@($"newuser-role-{roleName}")"
                                               checked="@_newUser.RoleSelections.GetValueOrDefault(roleName)"
                                               @onchange="e => OnNewUserRoleChanged(roleName, (bool)e.Value!)" />
                                        <label class="form-check-label small" for="@($"newuser-role-{roleName}")">
                                            @roleName
                                        </label>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <div class="mt-3 d-flex justify-content-end">
                        <button class="btn btn-success btn-sm"
                                disabled="@_newUser.IsSaving"
                                @onclick="CreateUserAsync">
                            @if (_newUser.IsSaving)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="ms-1">Creando...</span>
                            }
                            else
                            {
                                <span class="bi bi-person-plus me-1"></span>
                                <span>Crear usuario</span>
                            }
                        </button>
                    </div>
                </div>
            </div>

            @if (_isEditingUser)
            {
                <div class="card shadow-sm border-0 mb-3 admin-article-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0">
                                Editar usuario
                                <span class="text-muted small">(@_editUser.EmailOriginal)</span>
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm"
                                    type="button"
                                    @onclick="CancelEditUser">
                                <i class="bi bi-x-circle me-1"></i>Cancelar edición
                            </button>
                        </div>

                        <EditForm Model="_editUser" OnValidSubmit="SaveUserDataAsync">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger small mb-2" />

                            <div class="row g-3">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1">Nombre de usuario</label>
                                    <InputText class="form-control form-control-sm"
                                               @bind-Value="_editUser.UserName" />
                                    <ValidationMessage For="() => _editUser.UserName"
                                                       class="text-danger small" />
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label small mb-1">Correo electrónico</label>
                                    <InputText class="form-control form-control-sm"
                                               @bind-Value="_editUser.Email" />
                                    <ValidationMessage For="() => _editUser.Email"
                                                       class="text-danger small" />
                                </div>
                                <div class="col-12 col-md-2">
                                    <label class="form-label small mb-1">Nueva contraseña</label>
                                    <InputText class="form-control form-control-sm"
                                               type="password"
                                               @bind-Value="_editUser.NewPassword" />
                                </div>
                                <div class="col-12 col-md-2">
                                    <label class="form-label small mb-1">Confirmar</label>
                                    <InputText class="form-control form-control-sm"
                                               type="password"
                                               @bind-Value="_editUser.ConfirmNewPassword" />
                                    <ValidationMessage For="() => _editUser.ConfirmNewPassword"
                                                       class="text-danger small" />
                                </div>
                            </div>

                            <div class="small text-muted mt-2">
                                Si no desea cambiar la contraseña, deje los campos de contraseña en blanco.
                            </div>

                            <div class="mt-3 d-flex justify-content-end">
                                <button type="submit"
                                        class="btn btn-primary btn-sm"
                                        disabled="@_editUser.IsSaving">
                                    @if (_editUser.IsSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        <span class="ms-1">Guardando cambios...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-save me-1"></i>
                                        <span>Guardar datos</span>
                                    }
                                </button>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(_editUser.Message))
                            {
                                <div class="small text-success mt-2">
                                    @_editUser.Message
                                </div>
                            }
                        </EditForm>
                    </div>
                </div>
            }

            <div class="card shadow-sm border-0 mb-3 admin-article-card">
                <div class="card-body">
                    <div class="row g-2 align-items-end">
                        <div class="col-12 col-md-6">
                            <label class="form-label small mb-1">Buscar usuario</label>
                            <input class="form-control form-control-sm"
                                   @bind="_search"
                                   placeholder="Buscar por nombre o correo..." />
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label small mb-1">Filtrar por rol</label>
                            <select class="form-select form-select-sm" @bind="_roleFilter">
                                <option value="">Todos</option>
                                @foreach (var role in _allRoleNames)
                                {
                                    <option value="@role">@role</option>
                                }
                            </select>
                        </div>
                        <div class="col-12 col-md-3 text-md-end">
                            <div class="small text-muted mt-3 mt-md-0">
                                Usuarios encontrados: @FilteredUsers.Count()
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (!FilteredUsers.Any())
            {
                <div class="alert alert-info small admin-article-card">
                    No se encontraron usuarios con los criterios seleccionados.
                </div>
            }
            else
            {
                <div class="card shadow-sm border-0 admin-article-card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table align-middle mb-0">
                                <thead class="table-light small">
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Email</th>
                                        @foreach (var roleName in _allRoleNames)
                                        {
                                            <th class="text-center">@roleName</th>
                                        }
                                        <th class="text-center" style="width: 240px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var user in FilteredUsers)
                                    {
                                        <tr>
                                            <td>
                                                <div class="fw-semibold">@user.UserName</div>
                                                @if (!string.IsNullOrWhiteSpace(user.Id))
                                                {
                                                    <div class="small text-muted">ID: @user.Id</div>
                                                }
                                            </td>
                                            <td>
                                                <div>@user.Email</div>
                                            </td>

                                            @foreach (var roleName in _allRoleNames)
                                            {
                                                <td class="text-center">
                                                    <input type="checkbox"
                                                           checked="@user.RoleSelections.GetValueOrDefault(roleName)"
                                                           @onchange="e => OnRoleChanged(user, roleName, (bool)e.Value!)" />
                                                </td>
                                            }

                                            <td class="text-center">
                                                <div class="d-flex flex-wrap justify-content-center gap-1">
                                                    <button class="btn btn-outline-secondary btn-sm"
                                                            disabled="@user.IsSaving"
                                                            @onclick="() => StartEditUser(user)">
                                                        <i class="bi bi-pencil me-1"></i>
                                                        Editar datos
                                                    </button>

                                                    <button class="btn btn-primary btn-sm"
                                                            disabled="@user.IsSaving"
                                                            @onclick="() => SaveUserRolesAsync(user)">
                                                        @if (user.IsSaving)
                                                        {
                                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                            <span class="ms-1">Guardando...</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="bi bi-save me-1"></span>
                                                            <span>Guardar roles</span>
                                                        }
                                                    </button>

                                                    <button class="btn btn-outline-danger btn-sm"
                                                            disabled="@user.IsSaving"
                                                            @onclick="() => DeleteUserAsync(user)">
                                                        <span class="bi bi-trash me-1"></span>
                                                        <span>Eliminar</span>
                                                    </button>
                                                </div>

                                                @if (!string.IsNullOrWhiteSpace(user.Message))
                                                {
                                                    <div class="small text-success mt-1">
                                                        @user.Message
                                                    </div>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</section>

@code {
    private List<UserWithRolesViewModel> _users = new();
    private List<string> _allRoleNames = new();

    private bool _isLoading = true;
    private string? _errorMessage;
    private string? _successMessage;

    private string _search = "";
    private string _roleFilter = "";

    private NewUserModel _newUser = new();

    private bool _isEditingUser;
    private EditUserModel _editUser = new();

    private IEnumerable<UserWithRolesViewModel> FilteredUsers =>
        GetFilteredUsers();

    protected override async Task OnInitializedAsync()
    {
        HeaderState.Set("bi bi-shield-lock", "Gestión de roles y usuarios", "Administra datos y permisos de los usuarios del sistema");
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            _successMessage = null;
            _isEditingUser = false;

            _allRoleNames = await RoleManager.Roles
                .OrderBy(r => r.Name)
                .Select(r => r.Name!)
                .ToListAsync();

            _newUser = new NewUserModel
            {
                RoleSelections = _allRoleNames.ToDictionary(r => r, _ => false)
            };

            var users = await UserManager.Users
                .OrderBy(u => u.UserName)
                .ToListAsync();

            var list = new List<UserWithRolesViewModel>();

            foreach (var u in users)
            {
                var roles = await UserManager.GetRolesAsync(u);

                var vm = new UserWithRolesViewModel
                {
                    Id = u.Id,
                    UserName = u.UserName,
                    Email = u.Email,
                    RoleSelections = _allRoleNames
                        .ToDictionary(
                            r => r,
                            r => roles.Contains(r)
                        )
                };

                list.Add(vm);
            }

            _users = list;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar usuarios y roles");
            _errorMessage = "Ocurrió un error al cargar los usuarios. Intente de nuevo.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private IEnumerable<UserWithRolesViewModel> GetFilteredUsers()
    {
        IEnumerable<UserWithRolesViewModel> query = _users;

        if (!string.IsNullOrWhiteSpace(_search))
        {
            var s = _search.Trim().ToLowerInvariant();
            query = query.Where(u =>
                (!string.IsNullOrWhiteSpace(u.UserName) && u.UserName!.ToLowerInvariant().Contains(s)) ||
                (!string.IsNullOrWhiteSpace(u.Email) && u.Email!.ToLowerInvariant().Contains(s))
            );
        }

        if (!string.IsNullOrWhiteSpace(_roleFilter))
        {
            query = query.Where(u =>
                u.RoleSelections.TryGetValue(_roleFilter, out var hasRole) && hasRole
            );
        }

        return query;
    }

    private void OnRoleChanged(UserWithRolesViewModel user, string roleName, bool isChecked)
    {
        if (!user.RoleSelections.ContainsKey(roleName))
        {
            user.RoleSelections.Add(roleName, isChecked);
        }
        else
        {
            user.RoleSelections[roleName] = isChecked;
        }

        user.Message = null;
        _successMessage = null;
    }

    private void OnNewUserRoleChanged(string roleName, bool isChecked)
    {
        if (!_newUser.RoleSelections.ContainsKey(roleName))
        {
            _newUser.RoleSelections.Add(roleName, isChecked);
        }
        else
        {
            _newUser.RoleSelections[roleName] = isChecked;
        }

        _errorMessage = null;
        _successMessage = null;
    }

    private async Task CreateUserAsync()
    {
        try
        {
            _newUser.IsSaving = true;
            _errorMessage = null;
            _successMessage = null;

            if (string.IsNullOrWhiteSpace(_newUser.Email))
            {
                _errorMessage = "El correo electrónico es obligatorio.";
                return;
            }

            if (string.IsNullOrWhiteSpace(_newUser.Password) ||
                string.IsNullOrWhiteSpace(_newUser.ConfirmPassword))
            {
                _errorMessage = "Debe especificar la contraseña y su confirmación.";
                return;
            }

            if (_newUser.Password != _newUser.ConfirmPassword)
            {
                _errorMessage = "La contraseña y la confirmación no coinciden.";
                return;
            }

            var user = new ApplicationUser
            {
                UserName = string.IsNullOrWhiteSpace(_newUser.UserName)
                    ? _newUser.Email
                    : _newUser.UserName.Trim(),
                Email = _newUser.Email
            };

            var createResult = await UserManager.CreateAsync(user, _newUser.Password);
            if (!createResult.Succeeded)
            {
                _errorMessage = "Error al crear el usuario: " +
                                string.Join("; ", createResult.Errors.Select(e => e.Description));
                return;
            }

            var selectedRoles = _newUser.RoleSelections
                .Where(kv => kv.Value)
                .Select(kv => kv.Key)
                .ToList();

            if (selectedRoles.Any())
            {
                var addRolesResult = await UserManager.AddToRolesAsync(user, selectedRoles);
                if (!addRolesResult.Succeeded)
                {
                    _errorMessage = "Usuario creado, pero ocurrió un error al asignar los roles: " +
                                    string.Join("; ", addRolesResult.Errors.Select(e => e.Description));
                    return;
                }
            }

            _successMessage = $"Usuario '{user.UserName}' creado correctamente.";

            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al crear nuevo usuario");
            _errorMessage = "Ocurrió un error al crear el usuario. Revise el log o intente nuevamente.";
        }
        finally
        {
            _newUser.IsSaving = false;
        }
    }

    private async Task SaveUserRolesAsync(UserWithRolesViewModel userVm)
    {
        try
        {
            userVm.IsSaving = true;
            userVm.Message = null;
            _errorMessage = null;
            _successMessage = null;

            var user = await UserManager.FindByIdAsync(userVm.Id);
            if (user == null)
            {
                _errorMessage = "No se encontró el usuario en el sistema.";
                userVm.IsSaving = false;
                return;
            }

            var currentRoles = await UserManager.GetRolesAsync(user);
            var desiredRoles = userVm.RoleSelections
                .Where(kv => kv.Value)
                .Select(kv => kv.Key)
                .ToList();

            var rolesToAdd = desiredRoles.Except(currentRoles).ToList();
            var rolesToRemove = currentRoles.Except(desiredRoles).ToList();

            if (rolesToAdd.Any())
            {
                var addResult = await UserManager.AddToRolesAsync(user, rolesToAdd);
                if (!addResult.Succeeded)
                {
                    _errorMessage = "Ocurrió un error al agregar roles al usuario.";
                    Logger.LogError("AddToRolesAsync error: {Errors}",
                        string.Join(", ", addResult.Errors.Select(e => e.Description)));
                }
            }

            if (rolesToRemove.Any())
            {
                var removeResult = await UserManager.RemoveFromRolesAsync(user, rolesToRemove);
                if (!removeResult.Succeeded)
                {
                    _errorMessage = "Ocurrió un error al quitar roles al usuario.";
                    Logger.LogError("RemoveFromRolesAsync error: {Errors}",
                        string.Join(", ", removeResult.Errors.Select(e => e.Description)));
                }
            }

            if (string.IsNullOrWhiteSpace(_errorMessage))
            {
                userVm.Message = "Roles actualizados correctamente.";
                _successMessage = $"Roles actualizados para el usuario {userVm.UserName}.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar roles del usuario {UserId}", userVm.Id);
            _errorMessage = "Ocurrió un error al guardar los roles. Revise el log o intente nuevamente.";
        }
        finally
        {
            userVm.IsSaving = false;
        }
    }

    private async Task DeleteUserAsync(UserWithRolesViewModel userVm)
    {
        try
        {
            userVm.IsSaving = true;
            _errorMessage = null;
            _successMessage = null;

            var user = await UserManager.FindByIdAsync(userVm.Id);
            if (user == null)
            {
                _errorMessage = "No se encontró el usuario a eliminar.";
                userVm.IsSaving = false;
                return;
            }

            var deleteResult = await UserManager.DeleteAsync(user);
            if (!deleteResult.Succeeded)
            {
                _errorMessage = "Ocurrió un error al eliminar el usuario: " +
                                string.Join("; ", deleteResult.Errors.Select(e => e.Description));
                userVm.IsSaving = false;
                return;
            }

            _users.RemoveAll(u => u.Id == userVm.Id);
            _successMessage = $"Usuario '{userVm.UserName}' eliminado correctamente.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al eliminar usuario {UserId}", userVm.Id);
            _errorMessage = "Ocurrió un error al eliminar el usuario. Revise el log o intente nuevamente.";
        }
        finally
        {
            userVm.IsSaving = false;
        }
    }

    private void StartEditUser(UserWithRolesViewModel vm)
    {
        _editUser = new EditUserModel
        {
            Id = vm.Id,
            UserName = vm.UserName ?? "",
            Email = vm.Email ?? "",
            EmailOriginal = vm.Email ?? ""
        };
        _editUser.Message = null;
        _isEditingUser = true;
        _errorMessage = null;
        _successMessage = null;
    }

    private void CancelEditUser()
    {
        _isEditingUser = false;
        _editUser = new EditUserModel();
    }

    private async Task SaveUserDataAsync()
    {
        try
        {
            _editUser.IsSaving = true;
            _editUser.Message = null;
            _errorMessage = null;
            _successMessage = null;

            var user = await UserManager.FindByIdAsync(_editUser.Id);
            if (user == null)
            {
                _errorMessage = "No se encontró el usuario a editar.";
                return;
            }

            user.UserName = _editUser.UserName.Trim();
            user.Email = _editUser.Email.Trim();

            var updateResult = await UserManager.UpdateAsync(user);
            if (!updateResult.Succeeded)
            {
                _errorMessage = "Error al actualizar los datos del usuario: " +
                                string.Join("; ", updateResult.Errors.Select(e => e.Description));
                return;
            }

            if (!string.IsNullOrWhiteSpace(_editUser.NewPassword))
            {
                var token = await UserManager.GeneratePasswordResetTokenAsync(user);
                var passResult = await UserManager.ResetPasswordAsync(user, token, _editUser.NewPassword);

                if (!passResult.Succeeded)
                {
                    _errorMessage = "Los datos se actualizaron, pero hubo un error al cambiar la contraseña: " +
                                    string.Join("; ", passResult.Errors.Select(e => e.Description));
                    return;
                }
            }

            var vm = _users.FirstOrDefault(u => u.Id == _editUser.Id);
            if (vm != null)
            {
                vm.UserName = user.UserName;
                vm.Email = user.Email;
                vm.Message = "Datos actualizados.";
            }

            _editUser.Message = "Datos del usuario actualizados correctamente.";
            _successMessage = $"Datos actualizados para el usuario {user.UserName}.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al actualizar datos del usuario {UserId}", _editUser.Id);
            _errorMessage = "Ocurrió un error al actualizar los datos del usuario. Revise el log o intente nuevamente.";
        }
        finally
        {
            _editUser.IsSaving = false;
        }
    }

    private sealed class UserWithRolesViewModel
    {
        public string Id { get; set; } = string.Empty;
        public string? UserName { get; set; }
        public string? Email { get; set; }

        public Dictionary<string, bool> RoleSelections { get; set; } = new();

        public bool IsSaving { get; set; }
        public string? Message { get; set; }
    }

    private sealed class NewUserModel
    {
        public string Email { get; set; } = string.Empty;
        public string? UserName { get; set; }
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;

        public Dictionary<string, bool> RoleSelections { get; set; } = new();

        public bool IsSaving { get; set; }
    }

    private sealed class EditUserModel
    {
        public string Id { get; set; } = string.Empty;

        [Required]
        [StringLength(100)]
        public string UserName { get; set; } = string.Empty;

        [Required]
        [EmailAddress]
        [StringLength(150)]
        public string Email { get; set; } = string.Empty;

        public string EmailOriginal { get; set; } = string.Empty;

        [StringLength(100, MinimumLength = 6)]
        [DataType(DataType.Password)]
        public string? NewPassword { get; set; }

        [DataType(DataType.Password)]
        [Compare("NewPassword", ErrorMessage = "La nueva contraseña y su confirmación no coinciden.")]
        public string? ConfirmNewPassword { get; set; }

        public bool IsSaving { get; set; }
        public string? Message { get; set; }
    }
}
