@page "/admin/envios"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "EncargadoSistema,Administrador")]
@inject ApplicationDbContext Db
@inject NavigationManager Navigation

<section class="bg-dark text-white py-3 mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div class="me-3">
                <span class="fs-2">📰</span>
            </div>
            <div>
                <h1 class="h4 mb-1">Diario Magna Publicadora</h1>
                <div class="small">Panel de Envío a Noticieros</div>
            </div>
        </div>
        <div class="text-end small">
            <div class="fw-semibold">Encargado del Sistema</div>
            <div>Usuario Actual</div>
        </div>
    </div>
</section>

<div class="container mb-5">
    <div class="row g-4">
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-0 pb-1">
                    <h6 class="mb-0 fw-semibold">Filtros de búsqueda</h6>
                    <span class="small text-muted">Seleccione los criterios</span>
                </div>
                <div class="card-body pt-2">
                    <div class="mb-3">
                        <label class="form-label small fw-semibold mb-1">Categoría</label>
                        <InputSelect class="form-select form-select-sm" @bind-Value="_selectedCategoryId">
                            <option value="">Seleccione una Categoría</option>
                            <option value="-1">Todas</option>
                            @foreach (var c in _categories)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-semibold mb-1">Estado</label>
                        <InputSelect class="form-select form-select-sm" @bind-Value="_selectedStatus">
                            <option value="@((int)ArticleStatus.Approved)">Aprobados</option>
                            <option value="@((int)ArticleStatus.Sent)">Enviados</option>
                            <option value="-1">Aprobados y Enviados</option>
                        </InputSelect>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-semibold mb-1">Buscar</label>
                        <InputText class="form-control form-control-sm" @bind-Value="_searchTerm" placeholder="Busque por título o autor" />
                    </div>
                    <button class="btn btn-primary w-100 btn-sm" @onclick="ApplyFilters">
                        Buscar
                    </button>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pb-1">
                    <h6 class="mb-0 fw-semibold">Resumen de envíos</h6>
                    <span class="small text-muted">Estado general de publicaciones</span>
                </div>
                <div class="card-body pt-2">
                    <div class="d-flex justify-content-between small mb-2">
                        <span>Pendientes de enviar</span>
                        <span class="fw-semibold">@_stats.PendingToSend</span>
                    </div>
                    <div class="d-flex justify-content-between small mb-2">
                        <span>Artículos enviados</span>
                        <span class="fw-semibold text-success">@_stats.Sent</span>
                    </div>
                    <div class="d-flex justify-content-between small mb-2">
                        <span>Noticieros activos</span>
                        <span class="fw-semibold">@_stats.TotalNoticieros</span>
                    </div>
                    <hr class="my-2" />
                    <div class="d-flex justify-content-between small">
                        <span>Envíos realizados</span>
                        <span class="fw-semibold">@_stats.TotalRelations</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="mb-0 fw-semibold">Artículos para enviar a noticieros</h5>
                    <div class="small text-muted">Seleccione a qué noticieros se enviará cada noticia</div>
                </div>
                <button class="btn btn-outline-secondary btn-sm" @onclick="GoBack">
                    Volver a Solicitudes
                </button>
            </div>

            @if (_loading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border" role="status"></div>
                </div>
            }
            else if (!_articles.Any())
            {
                <div class="alert alert-info">
                    No hay artículos que coincidan con los filtros seleccionados.
                </div>
            }
            else
            {
                @foreach (var a in _articles)
                {
                    <div class="card mb-3 shadow-sm border-0">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-2 d-none d-md-flex">
                                    <div class="w-100 h-100 d-flex align-items-center justify-content-center border rounded bg-light" style="min-height:90px;">
                                        <span class="text-muted small">Imagen</span>
                                    </div>
                                </div>
                                <div class="col-md-10">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="fw-semibold">@a.Title</div>
                                            <div class="small text-muted">
                                                @a.AuthorName · @a.AuthorEmail · @a.CreatedAt.ToString("dd/MM/yyyy")
                                            </div>
                                            <div class="small text-muted">
                                                @a.CategoryName
                                                <span> · Estado: @a.StatusText</span>
                                            </div>
                                        </div>
                                        <div class="ms-3">
                                            @if (a.Status == ArticleStatus.Sent)
                                            {
                                                <span class="badge bg-success">Enviado</span>
                                            }
                                            else if (a.Status == ArticleStatus.Approved)
                                            {
                                                <span class="badge bg-primary">Aprobado</span>
                                            }
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <div class="small fw-semibold mb-1">Seleccione los noticieros</div>
                                        <div class="row">
                                            @foreach (var n in _noticieros)
                                            {
                                                <div class="col-12 col-sm-6 col-md-4">
                                                    <div class="form-check form-check-sm">
                                                        <input class="form-check-input"
                                                               type="checkbox"
                                                               checked="@a.SelectedNoticieroIds.Contains(n.Id)"
                                                               @onchange="e => ToggleNoticiero(a, n.Id, e.Value)">
                                                        <label class="form-check-label small">
                                                            @n.Name (@n.City)
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <div class="mt-3 d-flex flex-wrap justify-content-end gap-2">
                                        <button class="btn btn-outline-secondary btn-sm" @onclick="() => ViewArticle(a.Id)">
                                            Ver artículo
                                        </button>
                                        <button class="btn btn-success btn-sm" @onclick="() => SaveAndSend(a)">
                                            Guardar y marcar enviado
                                        </button>
                                    </div>

                                    @if (a.SelectedNoticieroIds.Any())
                                    {
                                        <div class="mt-2 small text-muted">
                                            Enviar a:
                                            @string.Join(", ", _noticieros.Where(n => a.SelectedNoticieroIds.Contains(n.Id)).Select(n => n.Name))
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code
{
    private List<ArticleEnvioItem> _articles = new List<ArticleEnvioItem>();
    private List<Category> _categories = new List<Category>();
    private List<Noticiero> _noticieros = new List<Noticiero>();
    private bool _loading = true;

    private string _selectedCategoryId = "";
    private string _selectedStatus = ((int)ArticleStatus.Approved).ToString();
    private string _searchTerm = "";

    private EnviosStats _stats = new EnviosStats();

    protected override async Task OnInitializedAsync()
    {
        await LoadFilters();
        await LoadStats();
        await LoadArticles();
        _loading = false;
    }

    private async Task LoadFilters()
    {
        _categories = await Db.Categories.Where(c => c.IsActive).OrderBy(c => c.Name).ToListAsync();
        _noticieros = await Db.Noticieros.Where(n => n.IsActive).OrderBy(n => n.Name).ToListAsync();
    }

    private async Task LoadStats()
    {
        _stats.PendingToSend = await Db.Articles.CountAsync(a => a.Status == ArticleStatus.Approved);
        _stats.Sent = await Db.Articles.CountAsync(a => a.Status == ArticleStatus.Sent);
        _stats.TotalNoticieros = await Db.Noticieros.CountAsync();
        _stats.TotalRelations = await Db.ArticleNoticieros.CountAsync();
    }

    private async Task LoadArticles()
    {
        var query = Db.Articles
            .Include(a => a.Category)
            .Include(a => a.ArticleNoticieros)
            .ThenInclude(an => an.Noticiero)
            .AsQueryable();

        if (!string.IsNullOrWhiteSpace(_selectedStatus) && _selectedStatus != "-1")
        {
            var statusValue = int.Parse(_selectedStatus);
            var status = (ArticleStatus)statusValue;
            query = query.Where(a => a.Status == status);
        }
        else
        {
            query = query.Where(a => a.Status == ArticleStatus.Approved || a.Status == ArticleStatus.Sent);
        }

        if (!string.IsNullOrWhiteSpace(_selectedCategoryId) && _selectedCategoryId != "-1")
        {
            var categoryId = int.Parse(_selectedCategoryId);
            query = query.Where(a => a.CategoryId == categoryId);
        }

        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            var term = _searchTerm.Trim().ToLower();
            query = query.Where(a => a.Title.ToLower().Contains(term) || a.AuthorName.ToLower().Contains(term));
        }

        var list = await query
            .OrderByDescending(a => a.CreatedAt)
            .ToListAsync();

        _articles = list.Select(a =>
        {
            var selectedIds = a.ArticleNoticieros.Select(r => r.NoticieroId).ToHashSet();
            return new ArticleEnvioItem
            {
                Id = a.Id,
                Title = a.Title,
                AuthorName = a.AuthorName,
                AuthorEmail = a.AuthorEmail,
                CreatedAt = a.CreatedAt,
                CategoryName = a.Category != null ? a.Category.Name : "",
                Status = a.Status,
                StatusText = GetStatusText(a.Status),
                SelectedNoticieroIds = selectedIds
            };
        }).ToList();
    }

    private async Task ApplyFilters()
    {
        _loading = true;
        await LoadArticles();
        _loading = false;
    }

    private static string GetStatusText(ArticleStatus status)
    {
        return status switch
        {
            ArticleStatus.PendingReview => "Pendiente",
            ArticleStatus.Approved => "Aprobado",
            ArticleStatus.Rejected => "Rechazado",
            ArticleStatus.Sent => "Enviado",
            _ => "Borrador"
        };
    }

    private void ToggleNoticiero(ArticleEnvioItem item, int noticieroId, object value)
    {
        var isChecked = value is bool b && b;
        if (isChecked)
        {
            item.SelectedNoticieroIds.Add(noticieroId);
        }
        else
        {
            if (item.SelectedNoticieroIds.Contains(noticieroId))
                item.SelectedNoticieroIds.Remove(noticieroId);
        }
    }

    private async Task SaveAndSend(ArticleEnvioItem item)
    {
        var entity = await Db.Articles
            .Include(a => a.ArticleNoticieros)
            .FirstOrDefaultAsync(a => a.Id == item.Id);

        if (entity == null)
            return;

        Db.ArticleNoticieros.RemoveRange(entity.ArticleNoticieros);

        foreach (var noticieroId in item.SelectedNoticieroIds)
        {
            var relation = new ArticleNoticiero
            {
                ArticleId = entity.Id,
                NoticieroId = noticieroId,
                SentAt = DateTime.UtcNow
            };
            Db.ArticleNoticieros.Add(relation);
        }

        if (item.SelectedNoticieroIds.Any())
        {
            entity.Status = ArticleStatus.Sent;
            entity.SentAt = DateTime.UtcNow;
        }

        await Db.SaveChangesAsync();
        await LoadStats();
        await LoadArticles();
    }

    private void ViewArticle(int id)
    {
        Navigation.NavigateTo($"/articles/details/{id}");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/admin/solicitudes");
    }

    private class ArticleEnvioItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string AuthorName { get; set; } = string.Empty;
        public string AuthorEmail { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
        public string CategoryName { get; set; } = string.Empty;
        public ArticleStatus Status { get; set; }
        public string StatusText { get; set; } = string.Empty;
        public HashSet<int> SelectedNoticieroIds { get; set; } = new HashSet<int>();
    }

    private class EnviosStats
    {
        public int PendingToSend { get; set; }
        public int Sent { get; set; }
        public int TotalNoticieros { get; set; }
        public int TotalRelations { get; set; }
    }
}
