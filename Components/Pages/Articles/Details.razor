@page "/articles/details/{id:int}"
@rendermode InteractiveServer
@* @attribute [Authorize(Roles = "Secretaria,RelacionesPublicas,EncargadoSistema,Administrador")] *@

@using DiarioMagna.Data
@using DiarioMagna.Domain.Models
@using Microsoft.EntityFrameworkCore
@using System.Linq
@inject ApplicationDbContext Db
@inject NavigationManager Navigation

<section class="admin-hero">
    <div class="container">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="d-flex align-items-center">
                <div class="admin-hero-icon me-3">
                    <span class="fs-2">📄</span>
                </div>
                <div>
                    <h1 class="h4 mb-1 text-white">Detalle del Artículo</h1>
                    <div class="small text-white-50">Visualización completa de la noticia</div>
                </div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-light btn-sm" @onclick="GoBack">
                    Volver al panel
                </button>
            </div>
        </div>
    </div>
</section>

<section class="admin-list-section">
    <div class="container">
        @if (_loading)
        {
            <div class="text-center py-5">
                <div class="spinner-border" role="status"></div>
            </div>
        }
        else if (_notFound)
        {
            <div class="alert alert-danger">
                No se encontró el artículo solicitado.
            </div>
        }
        else
        {
            <div class="row g-4">
                <div class="col-12 col-lg-4">
                    <div class="card shadow-sm border-0 admin-article-card mb-3">
                        <div class="card-body">
                            <h5 class="card-title mb-2">Información general</h5>
                            <div class="small mb-1">
                                <span class="fw-semibold">Autor:</span> @_model.AuthorName
                            </div>
                            <div class="small mb-1">
                                <span class="fw-semibold">Correo:</span> @_model.AuthorEmail
                            </div>
                            <div class="small mb-1">
                                <span class="fw-semibold">Fecha de creación:</span>
                                @_model.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            </div>
                            <div class="small mb-1">
                                <span class="fw-semibold">Categoría:</span> @_model.CategoryName
                            </div>
                            @if (!string.IsNullOrWhiteSpace(_model.PlanName))
                            {
                                <div class="small mb-1">
                                    <span class="fw-semibold">Plan:</span> @_model.PlanName
                                </div>
                            }
                            <div class="small mb-1">
                                <span class="fw-semibold">Estado:</span>
                                <span class="badge @GetStatusBadgeClass(_model.Status)">
                                    @_model.Status
                                </span>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(_model.ReferenceTitle))
                            {
                                <div class="small mt-2">
                                    <span class="fw-semibold">Referencia:</span>
                                    @if (_model.ReferenceArticleId.HasValue)
                                    {
                                        <a href="@GetDetailsUrl(_model.ReferenceArticleId.Value)">
                                            @_model.ReferenceTitle
                                        </a>
                                    }
                                    else
                                    {
                                        <span>@_model.ReferenceTitle</span>
                                    }
                                </div>
                            }

                            <div class="mt-3">
                                <div class="small fw-semibold mb-1">Enviado a noticieros</div>
                                @if (_model.Noticieros.Any())
                                {
                                    <ul class="small mb-0">
                                        @foreach (var n in _model.Noticieros)
                                        {
                                            <li>@n</li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <div class="small text-muted">
                                        Este artículo aún no ha sido enviado a ningún noticiero.
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-8">
                    <div class="card shadow-sm border-0 admin-article-card">
                        <div class="card-body">
                            <h2 class="h4 mb-3">@_model.Title</h2>

                            @if (!string.IsNullOrWhiteSpace(_model.AttachmentPath))
                            {
                                <div class="mb-3 text-center">
                                    <img src="@_model.AttachmentPath"
                                         class="img-fluid rounded"
                                         style="max-height: 320px; object-fit: cover;"
                                         alt="Imagen del artículo" />
                                </div>
                            }

                        <div class="article-content-text">
                            @(_model.Content?.Replace("\n", "<br />") is string html
                                                        ? (MarkupString)html
                                                        : (MarkupString)string.Empty)
                        </div>
                    </div>
                </div>
            </div>
        </div>
                }
    </div>
</section>

@code {
    [Parameter] public int Id { get; set; }

    private ArticleDetailsModel _model = new ArticleDetailsModel();
    private bool _loading = true;
    private bool _notFound;

    protected override async Task OnInitializedAsync()
    {
        var article = await Db.Articles
            .Include(a => a.Category)
            .Include(a => a.Plan)
            .Include(a => a.ArticleNoticieros)
                .ThenInclude(an => an.Noticiero)
            .FirstOrDefaultAsync(a => a.Id == Id);

        if (article == null)
        {
            _notFound = true;
            _loading = false;
            return;
        }

        var reference = await Db.ArticleReferences
            .Include(r => r.ReferencedArticle)
            .FirstOrDefaultAsync(r => r.ArticleId == article.Id);

        _model = new ArticleDetailsModel
        {
            Id = article.Id,
            Title = article.Title,
            Content = article.Content,
            AuthorName = article.AuthorName,
            AuthorEmail = article.AuthorEmail,
            CreatedAt = article.CreatedAt,
            CategoryName = article.Category?.Name ?? "General",
            PlanName = article.Plan?.Name,
            Status = article.Status,
            AttachmentPath = article.AttachmentPath,
            ReferenceArticleId = reference?.ReferencedArticleId,
            ReferenceTitle = reference?.ReferencedArticle?.Title,
            Noticieros = article.ArticleNoticieros
                .Where(an => an.Noticiero != null)
                .Select(an => an.Noticiero.Name)
                .Distinct()
                .OrderBy(n => n)
                .ToList()
        };

        _loading = false;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/mis-articulos");
    }

    private string GetStatusBadgeClass(ArticleStatus status)
    {
        return status switch
        {
            ArticleStatus.Aprobado => "bg-success",
            ArticleStatus.Rechazado => "bg-danger",
            ArticleStatus.Pendiente => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }

    private string GetDetailsUrl(int articleId)
    {
        return $"/articles/details/{articleId}";
    }

    private sealed class ArticleDetailsModel
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string Content { get; set; } = "";
        public string AuthorName { get; set; } = "";
        public string AuthorEmail { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public string CategoryName { get; set; } = "";
        public string? PlanName { get; set; }
        public ArticleStatus Status { get; set; }
        public string? AttachmentPath { get; set; }
        public int? ReferenceArticleId { get; set; }
        public string? ReferenceTitle { get; set; }
        public List<string> Noticieros { get; set; } = new();
    }
}
