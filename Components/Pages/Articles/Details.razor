@page "/articles/details/{id:int}"
@rendermode InteractiveServer
@inject ApplicationDbContext Db
@inject NavigationManager Navigation
@inject LayoutHeaderState HeaderState

<PageHeader Icon="bi bi-file-earmark-text"
            Title="Detalle del artículo"
            Description="Visualización completa de la noticia">
    <RightContent>
        <button class="btn btn-outline-light btn-sm" @onclick="GoBack">
            <i class="bi bi-arrow-left-circle me-1"></i>Volver
        </button>
    </RightContent>
</PageHeader>

<section class="admin-list-section">
    <div class="container">

        @if (_loading)
        {
            <div class="text-center py-5">
                <div class="spinner-border"></div>
            </div>
        }
        else if (_notFound)
        {
            <div class="alert alert-danger admin-article-card">
                No se encontró el artículo solicitado.
            </div>
        }
        else
        {
            <div class="row g-4">

                <div class="col-12 col-lg-4">
                    <div class="card shadow-sm border-0 admin-article-card mb-3">
                        <div class="card-body">

                            <h5 class="card-title mb-3 d-flex align-items-center gap-2">
                                <i class="bi bi-info-circle"></i>
                                <span>Información general</span>
                            </h5>

                            <div class="small mb-2">
                                <span class="fw-semibold">Autor:</span><br /> @_model.AuthorName
                            </div>

                            <div class="small mb-2">
                                <span class="fw-semibold">Correo:</span><br /> @_model.AuthorEmail
                            </div>

                            <div class="small mb-2">
                                <span class="fw-semibold">Fecha de creación:</span><br />
                                @_model.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            </div>

                            <div class="small mb-2">
                                <span class="fw-semibold">Categoría:</span><br /> @_model.CategoryName
                            </div>

                            @if (!string.IsNullOrWhiteSpace(_model.PlanName))
                            {
                                <div class="small mb-2">
                                    <span class="fw-semibold">Plan:</span><br /> @_model.PlanName
                                </div>
                            }

                            <div class="small mb-2">
                                <span class="fw-semibold">Estado:</span><br />
                                <span class="badge @GetStatusBadgeClass(_model.Status)">
                                    @_model.Status
                                </span>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(_model.ReferenceTitle))
                            {
                                <div class="small mb-2">
                                    <span class="fw-semibold">Referencia:</span><br />
                                    @if (_model.ReferenceArticleId.HasValue)
                                    {
                                        <a href="@GetDetailsUrl(_model.ReferenceArticleId.Value)">
                                            @_model.ReferenceTitle
                                        </a>
                                    }
                                    else
                                    {
                                        @_model.ReferenceTitle
                                    }
                                </div>
                            }

                            <div class="mt-3">
                                <div class="small fw-semibold mb-1">Enviado a noticieros</div>

                                @if (_model.Noticieros.Any())
                                {
                                    <ul class="small mb-0">
                                        @foreach (var n in _model.Noticieros)
                                        {
                                            <li>@n</li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <div class="small text-muted">
                                        Este artículo aún no ha sido enviado a ningún noticiero.
                                    </div>
                                }
                            </div>

                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-8">
                    <div class="card shadow-sm border-0 admin-article-card">
                        <div class="card-body">

                            <h2 class="h4 mb-3">@_model.Title</h2>

                            @if (!string.IsNullOrWhiteSpace(_model.AttachmentPath))
                            {
                                <div class="mb-3 text-center">
                                    <img src="@_model.AttachmentPath"
                                         class="img-fluid rounded shadow-sm"
                                         style="max-height: 340px; object-fit: cover;"
                                         alt="Imagen del artículo" />
                                </div>
                            }

                            <div class="article-content-text">
                                @((MarkupString)_model.Content.Replace("\n", "<br />"))
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        }
    </div>
</section>

@code {
    [Parameter] public int Id { get; set; }

    private ArticleDetailsModel _model = new();
    private bool _loading = true;
    private bool _notFound;

    protected override async Task OnInitializedAsync()
    {
        HeaderState.Set("bi bi-file-earmark-text", "Detalle del artículo", "Información completa de la noticia");

        var article = await Db.Articles
            .Include(a => a.Category)
            .Include(a => a.Plan)
            .Include(a => a.ArticleNoticieros).ThenInclude(an => an.Noticiero)
            .FirstOrDefaultAsync(a => a.Id == Id);

        if (article == null)
        {
            _notFound = true;
            _loading = false;
            return;
        }

        var reference = await Db.ArticleReferences
            .Include(r => r.ReferencedArticle)
            .FirstOrDefaultAsync(r => r.ArticleId == article.Id);

        _model = new ArticleDetailsModel
        {
            Id = article.Id,
            Title = article.Title,
            Content = article.Content,
            AuthorName = article.AuthorName,
            AuthorEmail = article.AuthorEmail,
            CreatedAt = article.CreatedAt,
            CategoryName = article.Category?.Name ?? "General",
            PlanName = article.Plan?.Name,
            Status = article.Status,
            AttachmentPath = article.AttachmentPath,
            ReferenceArticleId = reference?.ReferencedArticleId,
            ReferenceTitle = reference?.ReferencedArticle?.Title,
            Noticieros = article.ArticleNoticieros
                .Where(an => an.Noticiero != null)
                .Select(an => an.Noticiero.Name)
                .Distinct()
                .OrderBy(n => n)
                .ToList()
        };

        _loading = false;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/mis-articulos");
    }

    private string GetStatusBadgeClass(ArticleStatus status)
    {
        return status switch
        {
            ArticleStatus.Aprobado => "bg-success",
            ArticleStatus.Rechazado => "bg-danger",
            ArticleStatus.Pendiente => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }

    private string GetDetailsUrl(int id)
    {
        return $"/articles/details/{id}";
    }

    private sealed class ArticleDetailsModel
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string Content { get; set; } = "";
        public string AuthorName { get; set; } = "";
        public string AuthorEmail { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public string CategoryName { get; set; } = "";
        public string? PlanName { get; set; }
        public ArticleStatus Status { get; set; }
        public string? AttachmentPath { get; set; }
        public int? ReferenceArticleId { get; set; }
        public string? ReferenceTitle { get; set; }
        public List<string> Noticieros { get; set; } = new();
    }
}
