@page "/articles/create"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Secretaria,RelacionesPublicas,Administrador")]

@using System.ComponentModel.DataAnnotations
@using System.IO
@using DiarioMagna.Data
@using DiarioMagna.Domain.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Hosting
@using DiarioMagna.Components.Shared
@using DiarioMagna.Services.Email

@inject ApplicationDbContext Db
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IWebHostEnvironment Env
@inject LayoutHeaderState HeaderState
@inject INoticieroEmailService noticieroEmailService
@inject UserManager<ApplicationUser> UserManager

<PageHeader Icon="bi bi-file-earmark-plus"
            Title="Crear nuevo artículo"
            Description="Registra una noticia y envíala al flujo editorial para revisión y envío a noticieros.">
</PageHeader>

<section class="admin-list-section">
    <div class="container">
        <div class="row g-4">

            <div class="col-12 col-lg-4">
                <div class="card shadow-sm border-0 admin-article-card mb-3">
                    <div class="card-body">
                        <h5 class="card-title mb-2 d-flex align-items-center gap-2">
                            <i class="bi bi-clipboard-data"></i>
                            <span>Resumen del artículo</span>
                        </h5>

                        <div class="small mb-2">
                            <span class="fw-semibold">Título actual:</span><br />
                            <span>@(string.IsNullOrWhiteSpace(_model.Title) ? "Sin título" : _model.Title)</span>
                        </div>

                        <div class="small mb-2">
                            <span class="fw-semibold">Contenido:</span><br />
                            <span>@(_model.Content?.Length > 0 ? $"{_model.Content.Length} caracteres" : "Sin contenido")</span>
                        </div>

                        <div class="small mb-2">
                            <span class="fw-semibold">Referencia:</span><br />
                            <span>@GetReferenceSummary()</span>
                        </div>

                        <div class="small text-muted mt-3 d-flex align-items-start gap-2">
                            <i class="bi bi-person-badge"></i>
                            <span>El autor se tomará del usuario autenticado y se asociará al flujo de revisión.</span>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0 admin-article-card">
                    <div class="card-body">
                        <h6 class="card-title mb-2 d-flex align-items-center gap-2">
                            <i class="bi bi-lightbulb"></i>
                            <span>Tips rápidos</span>
                        </h6>
                        <ul class="small mb-0">
                            <li>Usa un título claro y directo.</li>
                            <li>Explica la noticia desde lo más importante a lo menos importante.</li>
                            <li>Si amplías o corriges otra noticia, selecciona la referencia.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-8">
                <div class="card shadow-sm border-0 admin-article-card">
                    <div class="card-body">

                        @if (!string.IsNullOrWhiteSpace(_successMessage))
                        {
                            <div class="alert alert-success py-2 px-3 small mb-3 d-flex align-items-center gap-2">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>@_successMessage</span>
                            </div>
                        }

                        <EditForm Model="_model" OnValidSubmit="SaveArticle">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger small mb-2" />

                            <div class="mb-3">
                                <label class="form-label auth-label">Título del artículo<span class="text-danger">*</span></label>
                                <InputText class="form-control auth-input"
                                           @bind-Value="_model.Title"
                                           placeholder="Ejemplo: Municipio X inaugura nuevo parque tecnológico" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">Categoría<span class="text-danger">*</span></label>
                                <InputSelect class="form-select form-select-sm"
                                             @bind-Value="_model.CategoryId">
                                    @foreach (var cat in _categories)
                                    {
                                        <option value="@cat.Id">@cat.Name</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">Referencia a otra noticia (opcional)</label>
                                <InputSelect class="form-select form-select-sm"
                                             @bind-Value="_model.ReferencedArticleId">
                                    <option value="">Noticia sin referencia</option>
                                    @foreach (var refArt in _availableReferences)
                                    {
                                        <option value="@refArt.Id">@refArt.Title</option>
                                    }
                                </InputSelect>
                                <div class="small text-muted mt-1">
                                    Úsalo si este artículo amplía, corrige o está enlazado a otra noticia previa.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">Contenido del artículo<span class="text-danger">*</span></label>
                                <InputTextArea class="form-control"
                                               style="min-height: 220px;"
                                               @bind-Value="_model.Content"
                                               placeholder="Escribe aquí la noticia completa..." />
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">Archivo adjunto (opcional)</label>
                                <div class="upload-dropzone">
                                    <InputFile class="upload-input" OnChange="OnFileChange" />
                                    <div class="text-center small text-muted">
                                        <i class="bi bi-cloud-arrow-up fs-5 d-block mb-1"></i>
                                        <span>Haz clic aquí para seleccionar un archivo (máx. 10 MB)</span>
                                        @if (!string.IsNullOrWhiteSpace(_uploadedFileName))
                                        {
                                            <div class="mt-2">
                                                <span class="fw-semibold">Archivo seleccionado:</span><br />
                                                @_uploadedFileName
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex align-content-end mt-4">
                                <button type="button"
                                        class="btn btn-outline-danger d-inline-flex align-items-center"
                                        @onclick="Cancel">
                                    <i class="bi bi-x-circle me-1"></i>
                                    <span>Cancelar</span>
                                </button>

                                <button type="submit"
                                        class="btn btn-primary auth-submit align-items-center"
                                        disabled="@_saving">
                                    @if (_saving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Enviando...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-send-fill me-1"></i>
                                        <span>Publicar artículo</span>
                                    }
                                </button>
                            </div>

                        </EditForm>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

@code {
    private ArticleCreateModel _model = new ArticleCreateModel();
    private List<ArticleReferenceItem> _availableReferences = new();
    private List<Category> _categories = new();
    private bool _saving;
    private string? _uploadedFileName;
    private IBrowserFile? _uploadedFile;
    private int _defaultCategoryId;
    private int? _defaultPlanId;
    private string? _successMessage;

    protected override async Task OnInitializedAsync()
    {
        HeaderState.Set("bi bi-file-earmark-plus", "Crear artículo", "Redacta una nueva noticia para el sistema");

        await EnsureDefaultPlan();
        await EnsureDefaultCategories();
        await LoadCategories();
        await LoadReferences();
    }

    private async Task EnsureDefaultPlan()
    {
        var defaultPlan = await Db.Plans.OrderBy(p => p.Id).FirstOrDefaultAsync();
        if (defaultPlan != null)
            _defaultPlanId = defaultPlan.Id;
    }

    private async Task LoadReferences()
    {
        _availableReferences = await Db.Articles
            .OrderByDescending(a => a.CreatedAt)
            .Take(20)
            .Select(a => new ArticleReferenceItem { Id = a.Id, Title = a.Title })
            .ToListAsync();
    }

    private async Task EnsureDefaultCategories()
    {
        var existingNames = await Db.Categories.Select(c => c.Name).ToListAsync();

        var defaults = new List<string>
        {
            "Economía",
            "Política",
            "Artes y Cultura",
            "Tecnología",
            "Internacionales",
            "Deportes"
        };

        foreach (var name in defaults)
        {
            if (!existingNames.Contains(name))
                Db.Categories.Add(new Category { Name = name, IsActive = true });
        }

        await Db.SaveChangesAsync();
    }

    private async Task LoadCategories()
    {
        _categories = await Db.Categories
            .Where(c => c.IsActive)
            .OrderBy(c => c.Name)
            .ToListAsync();

        if (_categories.Any())
            _model.CategoryId = _categories.First().Id;
    }

    private async Task SaveArticle()
    {
        _saving = true;
        _successMessage = null;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var name = user.Identity?.Name ?? "";
        var email = user.Claims.FirstOrDefault(c => c.Type == "email")?.Value ?? name;

        string? attachmentPath = null;

        if (_uploadedFile != null)
        {
            var uploadsFolder = Path.Combine(Env.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadsFolder);

            var fileName = $"{Guid.NewGuid()}{Path.GetExtension(_uploadedFile.Name)}";
            var filePath = Path.Combine(uploadsFolder, fileName);

            using var stream = File.Create(filePath);
            await _uploadedFile.OpenReadStream(10 * 1024 * 1024).CopyToAsync(stream);

            attachmentPath = $"/uploads/{fileName}";
        }

        var article = new Article
        {
            Title = _model.Title.Trim(),
            Content = _model.Content.Trim(),
            AuthorName = name,
            AuthorEmail = email,
            CreatedAt = DateTime.UtcNow,
            Status = ArticleStatus.Pendiente,
            CategoryId = _model.CategoryId,
            PlanId = _defaultPlanId,
            AttachmentPath = attachmentPath
        };

        Db.Articles.Add(article);
        await Db.SaveChangesAsync();

        var rolesDestino = new[]
         {
            "Secretaria",
            "Admin",
            "RelacionesPublicas",
            "EncargadoSistema"
        };

        var usuarios = new List<ApplicationUser>();

        foreach (var rol in rolesDestino)
        {
            var usersRol = await UserManager.GetUsersInRoleAsync(rol);
            usuarios.AddRange(usersRol);
        }

        var emails = usuarios
            .Where(u => !string.IsNullOrEmpty(u.Email))
            .Select(u => u.Email!)
            .Distinct()
            .ToList();

        foreach (var correo in emails)
        {
            await noticieroEmailService.SendArticleAsync(
                correo,
                article,
                article.AttachmentPath
            );
        }

        if (_model.ReferencedArticleId.HasValue)
        {
            Db.ArticleReferences.Add(new ArticleReference
            {
                ArticleId = article.Id,
                ReferencedArticleId = _model.ReferencedArticleId.Value
            });
            await Db.SaveChangesAsync();
        }

        _model = new ArticleCreateModel();
        _uploadedFile = null;
        _uploadedFileName = null;

        await LoadReferences();

        _successMessage = "Artículo enviado correctamente para revisión.";
        _saving = false;
        Navigation.NavigateTo("/");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

    private void OnFileChange(InputFileChangeEventArgs e)
    {
        _uploadedFile = e.File;
        _uploadedFileName = e.File.Name;
    }

    private string GetReferenceSummary()
    {
        if (!_model.ReferencedArticleId.HasValue)
            return "Sin referencia.";

        var item = _availableReferences.FirstOrDefault(r => r.Id == _model.ReferencedArticleId.Value);
        return item?.Title ?? "Referencia seleccionada.";
    }

    private sealed class ArticleCreateModel
    {
        [Required]
        [StringLength(200)]
        public string Title { get; set; } = "";

        [Required]
        [MinLength(20)]
        public string Content { get; set; } = "";

        [Required]
        public int CategoryId { get; set; }

        public int? ReferencedArticleId { get; set; }
    }

    private sealed class ArticleReferenceItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
    }
}
