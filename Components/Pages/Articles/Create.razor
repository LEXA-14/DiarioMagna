@page "/articles/create"
@rendermode InteractiveServer
@* @attribute [Authorize(Roles = "Secretaria,RelacionesPublicas,Administrador")] *@

@using System.ComponentModel.DataAnnotations
@using System.IO
@using DiarioMagna.Data
@using DiarioMagna.Domain.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Hosting
@inject ApplicationDbContext Db
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IWebHostEnvironment Env

<section class="admin-hero">
    <div class="container">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="d-flex align-items-center">
                <div class="admin-hero-icon me-3">
                    <span class="fs-2">📝</span>
                </div>
                <div>
                    <h1 class="h4 mb-1 text-white">Crear Nuevo Artículo</h1>
                    <div class="small text-white-50">Plataforma de gestión de noticias</div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="admin-list-section">
    <div class="container">
        <div class="row g-4">
            <div class="col-12 col-lg-4">
                <div class="card shadow-sm border-0 admin-article-card mb-3">
                  
                </div>

                <div class="card shadow-sm border-0 admin-article-card">
                    <div class="card-body">
                        <h5 class="card-title mb-2">Resumen</h5>
                        <div class="small mb-1">
                            <span class="fw-semibold">Título actual:</span>
                            <span>@(string.IsNullOrWhiteSpace(_model.Title) ? "Sin título" : _model.Title)</span>
                        </div>
                        <div class="small mb-1">
                            <span class="fw-semibold">Contenido:</span>
                            <span>@(_model.Content?.Length > 0 ? $"{_model.Content.Length} caracteres" : "Sin contenido")</span>
                        </div>
                        <div class="small mb-1">
                            <span class="fw-semibold">Referencia:</span>
                            <span>@GetReferenceSummary()</span>
                        </div>
                        <div class="small text-muted mt-2">
                            El autor se tomará del usuario autenticado.
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-8">
                <div class="card shadow-sm border-0 admin-article-card">
                    <div class="card-body">
                        @if (!string.IsNullOrWhiteSpace(_successMessage))
                        {
                            <div class="alert alert-success py-2 px-3 small mb-3">
                                @_successMessage
                            </div>
                        }

                        <EditForm Model="_model" OnValidSubmit="SaveArticle">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger small" />

                            <div class="mb-3">
                                <label class="form-label auth-label">Título del Artículo</label>
                                <InputText class="form-control auth-input" @bind-Value="_model.Title" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label auth-label">Categoría</label>
                                <InputSelect class="form-select" @bind-Value="_model.CategoryId">
                                    @foreach (var cat in _categories)
                                    {
                                        <option value="@cat.Id">@cat.Name</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">Con</label>
                                <InputSelect class="form-select" @bind-Value="_model.ReferencedArticleId">
                                    <option value="">Noticia sin referencia</option>
                                    @foreach (var refArt in _availableReferences)
                                    {
                                        <option value="@refArt.Id">@refArt.Title</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">Contenido del artículo</label>
                                <InputTextArea class="form-control" style="min-height: 180px;" @bind-Value="_model.Content" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">Subir Archivo (Imagen, PDF, Documento, Video)</label>
                                <InputFile OnChange="OnFileChange" />
                                @if (!string.IsNullOrWhiteSpace(_uploadedFileName))
                                {
                                    <div class="small text-muted mt-1">
                                        Archivo seleccionado: @_uploadedFileName
                                    </div>
                                }
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-4">
                               
                                <button type="button" class="btn btn-danger" style="width: auto;" @onclick="Cancel">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary auth-submit" style="width: auto;" disabled="@_saving">
                                    Publicar Artículo
                                </button>
                            </div>

                   
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@code {
    private ArticleCreateModel _model = new ArticleCreateModel();
    private List<ArticleReferenceItem> _availableReferences = new List<ArticleReferenceItem>();
    private List<Category> _categories = new List<Category>();
    private bool _saving;
    private string? _uploadedFileName;
    private IBrowserFile? _uploadedFile;
    private int _defaultCategoryId;
    private int? _defaultPlanId;
    private string? _successMessage;

    protected override async Task OnInitializedAsync()
    {
        await EnsureDefaultPlan();
        await EnsureDefaultCategories();
        await LoadCategories();
        await LoadReferences();
    }

    private async Task EnsureDefaultPlan()
    {
        // var defaultCategory = await Db.Categories.OrderBy(c => c.Id).FirstOrDefaultAsync();
        // if (defaultCategory == null)
        // {
        //     var newCategory = new Category
        //     {
        //         Name = "General",
        //         IsActive = true
        //     };
        //     Db.Categories.Add(newCategory);
        //     await Db.SaveChangesAsync();
        //     _defaultCategoryId = newCategory.Id;
        // }
        // else
        // {
        //     _defaultCategoryId = defaultCategory.Id;
        // }

        var defaultPlan = await Db.Plans.OrderBy(p => p.Id).FirstOrDefaultAsync();
        if (defaultPlan != null)
        {
            _defaultPlanId = defaultPlan.Id;
        }
    }

    private async Task LoadReferences()
    {
        _availableReferences = await Db.Articles
            .OrderByDescending(a => a.CreatedAt)
            .Take(20)
            .Select(a => new ArticleReferenceItem
            {
                Id = a.Id,
                Title = a.Title
            })
            .ToListAsync();
    }

    private async Task EnsureDefaultCategories()
    {
        if (!await Db.Categories.AnyAsync())
        {
            var defaults = new List<Category>
        {
            new Category { Name = "Economía", IsActive = true },
            new Category { Name = "Política", IsActive = true },
            new Category { Name = "Artes y Cultura", IsActive = true },
            new Category { Name = "Tecnología", IsActive = true },
            new Category { Name = "Internacionales", IsActive = true },
            new Category { Name = "Deportes", IsActive = true }
        };

            Db.Categories.AddRange(defaults);
            await Db.SaveChangesAsync();
        }
    }
    private async Task LoadCategories()
    {
        _categories = await Db.Categories
            .Where(c => c.IsActive)
            .OrderBy(c => c.Name)
            .ToListAsync();

        if (_categories.Any())
        {
            _model.CategoryId = _categories.First().Id;
        }
    }

    private async Task SaveArticle()
    {
        _saving = true;
        _successMessage = null;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var authorName = user.Identity?.Name ?? "Usuario";
        var authorEmail = user.Claims.FirstOrDefault(c => c.Type == "email")?.Value ?? "";

        string? attachmentPath = null;
        if (_uploadedFile != null)
        {
            var uploadsFolder = Path.Combine(Env.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadsFolder);
            var fileName = $"{Guid.NewGuid()}{Path.GetExtension(_uploadedFile.Name)}";
            var filePath = Path.Combine(uploadsFolder, fileName);
            using var stream = File.Create(filePath);
            await _uploadedFile.OpenReadStream(10 * 1024 * 1024).CopyToAsync(stream);
            attachmentPath = $"/uploads/{fileName}";
        }

        var article = new Article
        {
            Title = _model.Title.Trim(),
            Content = _model.Content.Trim(),
            AuthorName = authorName,
            AuthorEmail = authorEmail,
            CreatedAt = DateTime.UtcNow,
            Status = ArticleStatus.Pendiente,
            CategoryId = _model.CategoryId,
            PlanId = _defaultPlanId,
            AttachmentPath = attachmentPath
        };

        Db.Articles.Add(article);
        await Db.SaveChangesAsync();

        if (_model.ReferencedArticleId.HasValue)
        {
            var reference = new ArticleReference
            {
                ArticleId = article.Id,
                ReferencedArticleId = _model.ReferencedArticleId.Value
            };
            Db.ArticleReferences.Add(reference);
            await Db.SaveChangesAsync();
        }

        _model = new ArticleCreateModel();
        _uploadedFile = null;
        _uploadedFileName = null;
        await LoadReferences();

        _successMessage = "Artículo enviado correctamente para revisión.";
        _saving = false;
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

    private void OnFileChange(InputFileChangeEventArgs e)
    {
        _uploadedFile = e.File;
        _uploadedFileName = e.File.Name;
    }

    private string GetReferenceSummary()
    {
        if (!_model.ReferencedArticleId.HasValue)
            return "Sin referencia.";

        var item = _availableReferences.FirstOrDefault(r => r.Id == _model.ReferencedArticleId.Value);
        return item == null ? "Referencia seleccionada." : item.Title;
    }

    private sealed class ArticleCreateModel
    {
        [Required]
        [StringLength(200)]
        public string Title { get; set; } = "";

        [Required]
        [MinLength(20, ErrorMessage = "El contenido debe tener al menos 20 caracteres.")]
        public string Content { get; set; } = "";

        [Required(ErrorMessage = "Debe seleccionar una categoría")]
        public int CategoryId { get; set; }

        public int? ReferencedArticleId { get; set; }
    }

    private sealed class ArticleReferenceItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
    }
}
