@page "/articles/create"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Secretaria,RelacionesPublicas,Administrador")]
@inject ApplicationDbContext Db
@inject NavigationManager Navigation
@inject IWebHostEnvironment Env
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider

<section class="bg-dark text-white py-3 mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div class="me-3">
                <span class="fs-2">📰</span>
            </div>
            <div>
                <h1 class="h4 mb-1">Diario Magna Publicadora</h1>
                <div class="small">Crear Nuevo Artículo</div>
            </div>
        </div>
        <div class="text-end small">
            <div class="fw-semibold">Secretaria</div>
            @if (!string.IsNullOrWhiteSpace(_currentUserName))
            {
                <div>@_currentUserName</div>
            }
            else
            {
                <div>Usuario no autenticado</div>
            }
        </div>
    </div>
</section>

<div class="container mb-5">
    <div class="row g-3">
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body">
                    <div class="small text-muted mb-2">Flujo del Artículo</div>
                    <ol class="small mb-0">
                        <li>Secretaría crea y envía la noticia.</li>
                        <li>Relaciones Públicas revisa y aprueba.</li>
                        <li>Encargado del sistema selecciona noticieros.</li>
                    </ol>
                </div>
            </div>
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="small text-muted mb-2">Resumen</div>
                    <div class="small">
                        Título actual:
                        <span class="fw-semibold">
                            @(_model.Title?.Length > 0 ? _model.Title : "Sin título")
                        </span>
                    </div>
                    <div class="small mt-1">
                        Categoría:
                        <span class="fw-semibold">
                            @_selectedCategoryName
                        </span>
                    </div>
                    <div class="small mt-1">
                        Plan:
                        <span class="fw-semibold">
                            @_selectedPlanName
                        </span>
                    </div>
                    <div class="small mt-3 text-muted">
                        El autor se tomará del usuario autenticado.
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <EditForm Model="_model" OnValidSubmit="HandleValidSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-semibold">Título del Artículo</label>
                                <InputText class="form-control" @bind-Value="_model.Title" />
                                <ValidationMessage For="@(() => _model.Title)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Categoría</label>
                                <InputSelect class="form-select" @bind-Value="_model.CategoryId" @onchange="OnCategoryChanged">
                                    <option value="0">Seleccione una categoría</option>
                                    @foreach (var c in _categories)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => _model.CategoryId)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Plan (opcional)</label>
                                <InputSelect class="form-select" @bind-Value="_model.PlanId" @onchange="OnPlanChanged">
                                    <option value="">Sin plan</option>
                                    @foreach (var p in _plans)
                                    {
                                        <option value="@p.Id">@p.Name</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-semibold">Referencia</label>
                                <InputText class="form-control" @bind-Value="_model.ReferenceText" placeholder="Nota o referencia breve para Relaciones Públicas" />
                                <ValidationMessage For="@(() => _model.ReferenceText)" />
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-semibold">Contenido del Artículo</label>
                                <InputTextArea class="form-control" @bind-Value="_model.Content" rows="8" />
                                <ValidationMessage For="@(() => _model.Content)" />
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-semibold">Subir Archivo (Imagen, PDF, Documento, Video)</label>
                                <div class="upload-dropzone d-flex flex-column align-items-center justify-content-center text-center">
                                    <InputFile OnChange="HandleFileSelected" class="upload-input" />
                                    <div class="mb-2">
                                        <span class="display-6">⬆️</span>
                                    </div>
                                    <div class="small">
                                        Haz clic para seleccionar un archivo<br />
                                        Formatos: JPG, PNG, PDF, DOC, DOCX, MP4
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(_selectedFileName))
                                    {
                                        <div class="mt-2 small text-muted">
                                            Archivo seleccionado: @_selectedFileName
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary px-4" @onclick="Cancel">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary px-4">
                                Enviar a Revisión
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code
{
    private ArticleInputModel _model = new ArticleInputModel();
    private List<Category> _categories = new List<Category>();
    private List<Plan> _plans = new List<Plan>();
    private IBrowserFile _uploadedFile;
    private string _selectedFileName = string.Empty;

    private string _currentUserName = string.Empty;
    private string _currentUserEmail = string.Empty;
    private string _currentUserId = string.Empty;

    private string _selectedCategoryName = "Sin categoría";
    private string _selectedPlanName = "Sin plan";

    protected override async Task OnInitializedAsync()
    {
        _categories = await Db.Categories.Where(c => c.IsActive).OrderBy(c => c.Name).ToListAsync();
        _plans = await Db.Plans.OrderBy(p => p.Name).ToListAsync();

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user != null && user.Identity != null && user.Identity.IsAuthenticated)
        {
            _currentUserName = user.Identity.Name ?? string.Empty;
            _currentUserEmail = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? string.Empty;
            _currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        _uploadedFile = e.File;
        _selectedFileName = _uploadedFile?.Name ?? string.Empty;
    }

    private async Task HandleValidSubmit()
    {
        var article = new Article
        {
            AuthorName = string.IsNullOrWhiteSpace(_currentUserName) ? "Usuario" : _currentUserName,
            AuthorEmail = _currentUserEmail,
            Title = _model.Title,
            Content = _model.Content,
            CategoryId = _model.CategoryId,
            ReferenceText = _model.ReferenceText ?? string.Empty,
            Status = ArticleStatus.PendingReview,
            CreatedAt = DateTime.UtcNow,
            SecretaryUserId = _currentUserId
        };

        if (_model.PlanId.HasValue)
        {
            article.PlanId = _model.PlanId.Value;
        }

        if (_uploadedFile != null)
        {
            var uploadsFolder = Path.Combine(Env.WebRootPath, "uploads", "articles");
            if (!Directory.Exists(uploadsFolder))
                Directory.CreateDirectory(uploadsFolder);

            var fileName = Guid.NewGuid().ToString() + Path.GetExtension(_uploadedFile.Name);
            var filePath = Path.Combine(uploadsFolder, fileName);

            await using var stream = _uploadedFile.OpenReadStream(long.MaxValue);
            await using var fileStream = File.Create(filePath);
            await stream.CopyToAsync(fileStream);

            article.UploadedFilePath = Path.Combine("uploads", "articles", fileName).Replace("\\", "/");
        }

        Db.Articles.Add(article);
        await Db.SaveChangesAsync();

        Navigation.NavigateTo("/admin/solicitudes");
    }

    private void OnCategoryChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            var cat = _categories.FirstOrDefault(c => c.Id == id);
            _selectedCategoryName = cat != null ? cat.Name : "Sin categoría";
        }
        else
        {
            _selectedCategoryName = "Sin categoría";
        }
    }

    private void OnPlanChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            var p = _plans.FirstOrDefault(x => x.Id == id);
            _selectedPlanName = p != null ? p.Name : "Sin plan";
        }
        else
        {
            _selectedPlanName = "Sin plan";
        }
    }

    public class ArticleInputModel
    {
        [Required]
        [StringLength(200)]
        public string Title { get; set; } = string.Empty;

        [Required]
        [Range(1, int.MaxValue)]
        public int CategoryId { get; set; }

        public int? PlanId { get; set; }

        [StringLength(500)]
        public string ReferenceText { get; set; } = string.Empty;

        [Required]
        public string Content { get; set; } = string.Empty;
    }
}
