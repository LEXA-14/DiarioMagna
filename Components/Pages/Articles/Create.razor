@page "/articles/create"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Secretaria,RelacionesPublicas,Administrador")]

@using System.ComponentModel.DataAnnotations
@using System.IO
@using DiarioMagna.Data
@using DiarioMagna.Domain.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Hosting
@using DiarioMagna.Components.Shared

@inject ApplicationDbContext Db
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IWebHostEnvironment Env

<PageHeader Icon="bi bi-file-earmark-plus"
            Title="Crear nuevo artículo"
            Description="Registra una noticia y envíala al flujo editorial para revisión y envío a noticieros.">
</PageHeader>

<section class="admin-list-section">
    <div class="container">
        <div class="row g-4">
            <!-- Columna izquierda: resumen / estado -->
            <div class="col-12 col-lg-4">
                <div class="card shadow-sm border-0 admin-article-card mb-3">
                    <div class="card-body">
                        <h5 class="card-title mb-2 d-flex align-items-center gap-2">
                            <i class="bi bi-clipboard-data"></i>
                            <span>Resumen del artículo</span>
                        </h5>

                        <div class="small mb-2">
                            <span class="fw-semibold">Título actual:</span><br />
                            <span>
                                @(string.IsNullOrWhiteSpace(_model.Title)
                                                                ? "Sin título"
                                                                : _model.Title)
                            </span>
                        </div>

                        <div class="small mb-2">
                            <span class="fw-semibold">Contenido:</span><br />
                            <span>
                                @(_model.Content?.Length > 0
                                                                ? $"{_model.Content.Length} caracteres"
                                                                : "Sin contenido")
                            </span>
                        </div>

                        <div class="small mb-2">
                            <span class="fw-semibold">Referencia:</span><br />
                            <span>@GetReferenceSummary()</span>
                        </div>

                        <div class="small text-muted mt-3 d-flex align-items-start gap-2">
                            <i class="bi bi-person-badge"></i>
                            <span>
                                El autor se tomará del usuario autenticado y se asociará al flujo de revisión.
                            </span>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0 admin-article-card">
                    <div class="card-body">
                        <h6 class="card-title mb-2 d-flex align-items-center gap-2">
                            <i class="bi bi-lightbulb"></i>
                            <span>Tips rápidos</span>
                        </h6>
                        <ul class="small mb-0">
                            <li>Usa un título claro y directo.</li>
                            <li>En el contenido, explica la noticia desde lo más importante a lo menos importante.</li>
                            <li>Si amplías o corriges otra noticia, selecciona la referencia para enlazarlas.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: formulario principal -->
            <div class="col-12 col-lg-8">
                <div class="card shadow-sm border-0 admin-article-card">
                    <div class="card-body">
                        @if (!string.IsNullOrWhiteSpace(_successMessage))
                        {
                            <div class="alert alert-success py-2 px-3 small mb-3 d-flex align-items-center gap-2">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>@_successMessage</span>
                            </div>
                        }

                        <EditForm Model="_model" OnValidSubmit="SaveArticle">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger small" />

                            <div class="mb-3">
                                <label class="form-label auth-label">
                                    Título del artículo
                                    <span class="text-danger">*</span>
                                </label>
                                <InputText class="form-control auth-input"
                                           @bind-Value="_model.Title"
                                           placeholder="Ejemplo: Municipio X inaugura nuevo parque tecnológico" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">
                                    Categoría
                                    <span class="text-danger">*</span>
                                </label>
                                <InputSelect class="form-select" @bind-Value="_model.CategoryId">
                                    @foreach (var cat in _categories)
                                    {
                                        <option value="@cat.Id">@cat.Name</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">
                                    Referencia a otra noticia (opcional)
                                </label>
                                <InputSelect class="form-select" @bind-Value="_model.ReferencedArticleId">
                                    <option value="">Noticia sin referencia</option>
                                    @foreach (var refArt in _availableReferences)
                                    {
                                        <option value="@refArt.Id">@refArt.Title</option>
                                    }
                                </InputSelect>
                                <div class="small text-muted mt-1">
                                    Úsalo si este artículo amplía, corrige o está enlazado a otra noticia previa.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">
                                    Contenido del artículo
                                    <span class="text-danger">*</span>
                                </label>
                                <InputTextArea class="form-control"
                                               style="min-height: 200px;"
                                               @bind-Value="_model.Content"
                                               placeholder="Escribe aquí el cuerpo completo de la noticia..." />
                            </div>

                            <div class="mb-3">
                                <label class="form-label auth-label">
                                    Archivo adjunto (imagen, PDF, documento, video) – opcional
                                </label>
                                <div class="upload-dropzone">
                                    <InputFile class="upload-input" OnChange="OnFileChange" />
                                    <div class="text-center small text-muted">
                                        <i class="bi bi-cloud-arrow-up fs-5 d-block mb-1"></i>
                                        <span>
                                            Haz clic aquí para seleccionar un archivo (máx. 10 MB)
                                        </span>
                                        @if (!string.IsNullOrWhiteSpace(_uploadedFileName))
                                        {
                                            <div class="mt-2">
                                                <span class="fw-semibold">Archivo seleccionado:</span>
                                                <br />
                                                @_uploadedFileName
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <button type="button"
                                        class="btn btn-outline-danger d-inline-flex align-items-center"
                                        style="width: auto;"
                                        @onclick="Cancel">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Cancelar
                                </button>

                                <button type="submit"
                                        class="btn btn-primary auth-submit d-inline-flex align-items-center"
                                        style="width: auto;"
                                        disabled="@_saving">
                                    @if (_saving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"
                                              role="status"
                                              aria-hidden="true"></span>
                                        <span>Enviando...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-send-fill me-1"></i>
                                        <span>Publicar artículo</span>
                                    }
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@code {
    private ArticleCreateModel _model = new ArticleCreateModel();
    private List<ArticleReferenceItem> _availableReferences = new List<ArticleReferenceItem>();
    private List<Category> _categories = new List<Category>();
    private bool _saving;
    private string? _uploadedFileName;
    private IBrowserFile? _uploadedFile;
    private int _defaultCategoryId;
    private int? _defaultPlanId;
    private string? _successMessage;

    protected override async Task OnInitializedAsync()
    {
        await EnsureDefaultPlan();
        await EnsureDefaultCategories();
        await LoadCategories();
        await LoadReferences();
    }

    private async Task EnsureDefaultPlan()
    {
        var defaultPlan = await Db.Plans.OrderBy(p => p.Id).FirstOrDefaultAsync();
        if (defaultPlan != null)
        {
            _defaultPlanId = defaultPlan.Id;
        }
    }

    private async Task LoadReferences()
    {
        _availableReferences = await Db.Articles
            .OrderByDescending(a => a.CreatedAt)
            .Take(20)
            .Select(a => new ArticleReferenceItem
            {
                Id = a.Id,
                Title = a.Title
            })
            .ToListAsync();
    }

    private async Task EnsureDefaultCategories()
    {
        var existingCategories = await Db.Categories
            .Select(c => c.Name)
            .ToListAsync();

        var defaultCategories = new List<string>
        {
            "Economía",
            "Política",
            "Artes y Cultura",
            "Tecnología",
            "Internacionales",
            "Deportes"
        };

        foreach (var categoryName in defaultCategories)
        {
            if (!existingCategories.Contains(categoryName))
            {
                Db.Categories.Add(new Category
                {
                    Name = categoryName,
                    IsActive = true
                });
            }
        }

        await Db.SaveChangesAsync();
    }

    private async Task LoadCategories()
    {
        _categories = await Db.Categories
            .Where(c => c.IsActive)
            .OrderBy(c => c.Name)
            .ToListAsync();

        if (_categories.Any())
        {
            _model.CategoryId = _categories.First().Id;
        }
    }

    private async Task SaveArticle()
    {
        _saving = true;
        _successMessage = null;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var authorName = user.Identity?.Name ?? "Usuario";
        var authorEmail = user.Claims.FirstOrDefault(c => c.Type == "email")?.Value
                          ?? user.Identity?.Name
                          ?? "";

        string? attachmentPath = null;
        if (_uploadedFile != null)
        {
            var uploadsFolder = Path.Combine(Env.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadsFolder);
            var fileName = $"{Guid.NewGuid()}{Path.GetExtension(_uploadedFile.Name)}";
            var filePath = Path.Combine(uploadsFolder, fileName);
            using var stream = File.Create(filePath);
            await _uploadedFile.OpenReadStream(10 * 1024 * 1024).CopyToAsync(stream);
            attachmentPath = $"/uploads/{fileName}";
        }

        var article = new Article
        {
            Title = _model.Title.Trim(),
            Content = _model.Content.Trim(),
            AuthorName = authorName,
            AuthorEmail = authorEmail,
            CreatedAt = DateTime.UtcNow,
            Status = ArticleStatus.Pendiente,
            CategoryId = _model.CategoryId,
            PlanId = _defaultPlanId,
            AttachmentPath = attachmentPath
        };

        Db.Articles.Add(article);
        await Db.SaveChangesAsync();

        if (_model.ReferencedArticleId.HasValue)
        {
            var reference = new ArticleReference
            {
                ArticleId = article.Id,
                ReferencedArticleId = _model.ReferencedArticleId.Value
            };
            Db.ArticleReferences.Add(reference);
            await Db.SaveChangesAsync();
        }

        _model = new ArticleCreateModel();
        _uploadedFile = null;
        _uploadedFileName = null;
        await LoadReferences();

        _successMessage = "Artículo enviado correctamente para revisión.";
        _saving = false;
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

    private void OnFileChange(InputFileChangeEventArgs e)
    {
        _uploadedFile = e.File;
        _uploadedFileName = e.File.Name;
    }

    private string GetReferenceSummary()
    {
        if (!_model.ReferencedArticleId.HasValue)
            return "Sin referencia.";

        var item = _availableReferences
            .FirstOrDefault(r => r.Id == _model.ReferencedArticleId.Value);

        return item == null
            ? "Referencia seleccionada."
            : item.Title;
    }

    private sealed class ArticleCreateModel
    {
        [Required]
        [StringLength(200)]
        public string Title { get; set; } = "";

        [Required]
        [MinLength(20, ErrorMessage = "El contenido debe tener al menos 20 caracteres.")]
        public string Content { get; set; } = "";

        [Required(ErrorMessage = "Debe seleccionar una categoría")]
        public int CategoryId { get; set; }

        public int? ReferencedArticleId { get; set; }
    }

    private sealed class ArticleReferenceItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
    }
}
