@page "/articles/edit/{id:int}"
@rendermode InteractiveServer
@* @attribute [Authorize(Roles = "RelacionesPublicas,Administrador")] *@

@using System.ComponentModel.DataAnnotations
@using System.IO
@using DiarioMagna.Data
@using DiarioMagna.Domain.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Hosting
@inject ApplicationDbContext Db
@inject NavigationManager Navigation
@inject IWebHostEnvironment Env

<section class="admin-hero">
    <div class="container">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="d-flex align-items-center">
                <div class="admin-hero-icon me-3">
                    <span class="fs-2">📰</span>
                </div>
                <div>
                    <h1 class="h4 mb-1 text-white">Revisión de Artículo</h1>
                    <div class="small text-white-50">Relaciones Públicas · Aprobación de noticias</div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="admin-list-section">
    <div class="container">
        @if (_loading)
        {
            <div class="text-center py-5">
                <div class="spinner-border" role="status"></div>
            </div>
        }
        else if (_notFound)
        {
            <div class="alert alert-danger">No se encontró el artículo.</div>
        }
        else
        {
            <div class="row g-4">
                <div class="col-12 col-lg-4">
                    <div class="card shadow-sm border-0 admin-article-card mb-3">
                        <div class="card-body">
                            <h5 class="card-title mb-2">Información del Autor</h5>
                            <div class="small mb-1">
                                <span class="fw-semibold">Autor:</span> @_model.AuthorName
                            </div>
                            <div class="small mb-1">
                                <span class="fw-semibold">Correo:</span> @_model.AuthorEmail
                            </div>
                            <div class="small mb-1">
                                <span class="fw-semibold">Fecha:</span> @_model.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            </div>
                            <div class="small mb-1">
                                <span class="fw-semibold">Categoría:</span> @_model.CategoryName
                            </div>
                            <div class="small mb-1">
                                <span class="fw-semibold">Estado actual:</span>
                                <span class="badge bg-info text-dark">@_model.Status</span>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 admin-article-card">
                        <div class="card-body">
                            <h5 class="card-title mb-2">Imagen del artículo</h5>
                            @if (!string.IsNullOrWhiteSpace(_model.AttachmentPath))
                            {
                                <img src="@_model.AttachmentPath" class="img-fluid rounded mb-2" alt="Imagen del artículo" />
                                <div class="small text-muted mb-2">Imagen actual.</div>
                            }
                            else
                            {
                                <div class="small text-muted mb-2">Este artículo no tiene imagen adjunta.</div>
                            }

                            <div class="mb-2">
                                <label class="form-label auth-label">Reemplazar imagen (opcional)</label>
                                <InputFile OnChange="OnFileChange" />
                                @if (!string.IsNullOrWhiteSpace(_newFileName))
                                {
                                    <div class="small text-muted mt-1">
                                        Nueva imagen seleccionada: @_newFileName
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-8">
                    <div class="card shadow-sm border-0 admin-article-card">
                        <div class="card-body">
                            @if (!string.IsNullOrWhiteSpace(_statusMessage))
                            {
                                <div class="alert alert-info py-2 px-3 small mb-3">
                                    @_statusMessage
                                </div>
                            }

                            <EditForm Model="_model" OnValidSubmit="SaveArticle">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="text-danger small" />

                                <div class="mb-3">
                                    <label class="form-label auth-label">Título del Artículo</label>
                                    <InputText class="form-control auth-input" @bind-Value="_model.Title" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label auth-label">Contenido del artículo</label>
                                    <InputTextArea class="form-control" style="min-height: 220px;" @bind-Value="_model.Content" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label auth-label">Estado</label>
                                    <InputSelect class="form-select" @bind-Value="_model.Status">
                                        <option value="@ArticleStatus.Pendiente">Pendiente de revisión</option>
                                        <option value="@ArticleStatus.Aprobado">Aprobado</option>
                                        <option value="@ArticleStatus.Rechazado">Rechazado</option>
                                    </InputSelect>
                                </div>

                                <div class="d-flex justify-content-between gap-2 mt-4">
                                    <button type="button" class="btn btn-outline-secondary" @onclick="BackToList">
                                        Volver al panel
                                    </button>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" disabled="@_saving">
                                            Guardar cambios
                                        </button>
                                    </div>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</section>

@code {
    [Parameter] public int Id { get; set; }

    private EditArticleModel _model = new EditArticleModel();
    private bool _loading = true;
    private bool _notFound;
    private bool _saving;
    private string? _statusMessage;
    private IBrowserFile? _newFile;
    private string? _newFileName;

    protected override async Task OnInitializedAsync()
    {
        var entity = await Db.Articles
            .Include(a => a.Category)
            .FirstOrDefaultAsync(a => a.Id == Id);

        if (entity == null)
        {
            _notFound = true;
            _loading = false;
            return;
        }

        _model = new EditArticleModel
        {
            Id = entity.Id,
            Title = entity.Title,
            Content = entity.Content,
            AuthorName = entity.AuthorName,
            AuthorEmail = entity.AuthorEmail,
            CreatedAt = entity.CreatedAt,
            CategoryName = entity.Category?.Name ?? "General",
            Status = entity.Status,
            AttachmentPath = entity.AttachmentPath
        };

        _loading = false;
    }

    private async Task SaveArticle()
    {
        _saving = true;
        _statusMessage = null;

        var entity = await Db.Articles.FirstOrDefaultAsync(a => a.Id == _model.Id);
        if (entity == null)
        {
            _notFound = true;
            _saving = false;
            return;
        }

        entity.Title = _model.Title.Trim();
        entity.Content = _model.Content.Trim();
        entity.Status = _model.Status;

        if (_newFile != null)
        {
            var uploadsFolder = Path.Combine(Env.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadsFolder);
            var fileName = $"{Guid.NewGuid()}{Path.GetExtension(_newFile.Name)}";
            var filePath = Path.Combine(uploadsFolder, fileName);
            using var stream = File.Create(filePath);
            await _newFile.OpenReadStream(10 * 1024 * 1024).CopyToAsync(stream);
            entity.AttachmentPath = $"/uploads/{fileName}";
        }

        await Db.SaveChangesAsync();

        _model.AttachmentPath = entity.AttachmentPath;
        _newFile = null;
        _newFileName = null;

        _statusMessage = "Cambios guardados correctamente.";
        _saving = false;
    }

    private void BackToList()
    {
        Navigation.NavigateTo("/admin/solicitudes");
    }

    private void OnFileChange(InputFileChangeEventArgs e)
    {
        _newFile = e.File;
        _newFileName = e.File.Name;
    }

    private sealed class EditArticleModel
    {
        public int Id { get; set; }

        [Required]
        [StringLength(200)]
        public string Title { get; set; } = "";

        [Required]
        [MinLength(20)]
        public string Content { get; set; } = "";

        public string AuthorName { get; set; } = "";
        public string AuthorEmail { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public string CategoryName { get; set; } = "";
        public ArticleStatus Status { get; set; }
        public string? AttachmentPath { get; set; }
    }
}
