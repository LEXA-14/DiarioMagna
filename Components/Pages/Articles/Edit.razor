@page "/articles/edit/{id:int}"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "RelacionesPublicas,Administrador")]

@using System.ComponentModel.DataAnnotations
@using System.IO
@using DiarioMagna.Data
@using DiarioMagna.Domain.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Hosting
@using DiarioMagna.Components.Shared

@inject ApplicationDbContext Db
@inject NavigationManager Navigation
@inject IWebHostEnvironment Env
@inject LayoutHeaderState HeaderState

<PageHeader Icon="bi bi-journal-text"
            Title="Revisión de artículo"
            Description="Relaciones Públicas · Aprobación de noticias" />

<section class="admin-list-section">
    <div class="container">
        @if (_loading)
        {
            <div class="text-center py-5">
                <div class="spinner-border" role="status"></div>
            </div>
        }
        else if (_notFound)
        {
            <div class="alert alert-danger admin-article-card">
                No se encontró el artículo.
            </div>
        }
        else
        {
            <div class="row g-4">
                <div class="col-12 col-lg-4">
                    <div class="card shadow-sm border-0 admin-article-card mb-3">
                        <div class="card-body">
                            <h5 class="card-title mb-3 d-flex align-items-center gap-2">
                                <i class="bi bi-person-badge"></i>
                                <span>Información del autor</span>
                            </h5>

                            <div class="small mb-2">
                                <span class="fw-semibold">Autor:</span><br />
                                @_model.AuthorName
                            </div>
                            <div class="small mb-2">
                                <span class="fw-semibold">Correo:</span><br />
                                @_model.AuthorEmail
                            </div>
                            <div class="small mb-2">
                                <span class="fw-semibold">Fecha:</span><br />
                                @_model.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            </div>
                            <div class="small mb-2">
                                <span class="fw-semibold">Categoría:</span><br />
                                @_model.CategoryName
                            </div>
                            <div class="small mb-1">
                                <span class="fw-semibold">Estado actual:</span><br />
                                <span class="badge @GetStatusBadgeClass(_model.Status)">
                                    @_model.Status
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 admin-article-card">
                        <div class="card-body">
                            <h5 class="card-title mb-2 d-flex align-items-center gap-2">
                                <i class="bi bi-image"></i>
                                <span>Imagen del artículo</span>
                            </h5>

                            @if (!string.IsNullOrWhiteSpace(_model.AttachmentPath))
                            {
                                <div class="mb-2 text-center">
                                    <img src="@_model.AttachmentPath"
                                         class="img-fluid rounded shadow-sm"
                                         style="max-height: 260px; object-fit: cover;"
                                         alt="Imagen del artículo" />
                                </div>
                                <div class="small text-muted mb-2">Imagen actual.</div>
                            }
                            else
                            {
                                <div class="small text-muted mb-3">
                                    Este artículo no tiene imagen adjunta.
                                </div>
                            }

                            <div class="mb-2">
                                <label class="form-label auth-label">Reemplazar imagen (opcional)</label>
                                <div class="upload-dropzone">
                                    <InputFile class="upload-input" OnChange="OnFileChange" />
                                    <div class="text-center small text-muted">
                                        <i class="bi bi-cloud-arrow-up fs-5 d-block mb-1"></i>
                                        <span>Haz clic aquí para seleccionar una nueva imagen (máx. 10 MB)</span>
                                        @if (!string.IsNullOrWhiteSpace(_newFileName))
                                        {
                                            <div class="mt-2">
                                                <span class="fw-semibold">Nueva imagen seleccionada:</span><br />
                                                @_newFileName
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-8">
                    <div class="card shadow-sm border-0 admin-article-card">
                        <div class="card-body">

                            @if (!string.IsNullOrWhiteSpace(_statusMessage))
                            {
                                <div class="alert alert-info py-2 px-3 small mb-3 d-flex align-items-center gap-2">
                                    <i class="bi bi-info-circle-fill"></i>
                                    <span>@_statusMessage</span>
                                </div>
                            }

                            <EditForm Model="_model" OnValidSubmit="SaveArticle">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="text-danger small mb-2" />

                                <div class="mb-3">
                                    <label class="form-label auth-label">Título del artículo</label>
                                    <InputText class="form-control auth-input"
                                               @bind-Value="_model.Title" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label auth-label">Contenido del artículo</label>
                                    <InputTextArea class="form-control"
                                                   style="min-height: 220px;"
                                                   @bind-Value="_model.Content" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label auth-label">Estado</label>
                                    <InputSelect class="form-select form-select-sm"
                                                 @bind-Value="_model.Status">
                                        <option value="@ArticleStatus.Pendiente">Pendiente de revisión</option>
                                        <option value="@ArticleStatus.Aprobado">Aprobado</option>
                                        <option value="@ArticleStatus.Rechazado">Rechazado</option>
                                    </InputSelect>
                                </div>

                                <div class="d-flex justify-content-between align-items-center gap-2 mt-4">
                                    <button type="button"
                                            class="btn btn-outline-secondary d-inline-flex align-items-center"
                                            @onclick="BackToList">
                                        <i class="bi bi-arrow-left-circle me-1"></i>
                                        <span>Volver al panel</span>
                                    </button>

                                    <button type="submit"
                                            class="btn btn-primary auth-submit d-inline-flex align-items-center"
                                            disabled="@_saving">
                                        @if (_saving)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            <span>Guardando...</span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-save me-1"></i>
                                            <span>Guardar cambios</span>
                                        }
                                    </button>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</section>

@code {
    [Parameter] public int Id { get; set; }

    private EditArticleModel _model = new EditArticleModel();
    private bool _loading = true;
    private bool _notFound;
    private bool _saving;
    private string? _statusMessage;
    private IBrowserFile? _newFile;
    private string? _newFileName;

    protected override async Task OnInitializedAsync()
    {
        HeaderState.Set("bi bi-journal-text", "Revisión de artículo", "Relaciones Públicas · Aprobación de noticias");

        var entity = await Db.Articles
            .Include(a => a.Category)
            .FirstOrDefaultAsync(a => a.Id == Id);

        if (entity == null)
        {
            _notFound = true;
            _loading = false;
            return;
        }

        _model = new EditArticleModel
        {
            Id = entity.Id,
            Title = entity.Title,
            Content = entity.Content,
            AuthorName = entity.AuthorName,
            AuthorEmail = entity.AuthorEmail,
            CreatedAt = entity.CreatedAt,
            CategoryName = entity.Category?.Name ?? "General",
            Status = entity.Status,
            AttachmentPath = entity.AttachmentPath
        };

        _loading = false;
    }

    private async Task SaveArticle()
    {
        _saving = true;
        _statusMessage = null;

        var entity = await Db.Articles.FirstOrDefaultAsync(a => a.Id == _model.Id);
        if (entity == null)
        {
            _notFound = true;
            _saving = false;
            return;
        }

        entity.Title = _model.Title.Trim();
        entity.Content = _model.Content.Trim();
        entity.Status = _model.Status;

        if (_newFile != null)
        {
            var uploadsFolder = Path.Combine(Env.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadsFolder);
            var fileName = $"{Guid.NewGuid()}{Path.GetExtension(_newFile.Name)}";
            var filePath = Path.Combine(uploadsFolder, fileName);
            using var stream = File.Create(filePath);
            await _newFile.OpenReadStream(10 * 1024 * 1024).CopyToAsync(stream);
            entity.AttachmentPath = $"/uploads/{fileName}";
        }

        await Db.SaveChangesAsync();

        _model.AttachmentPath = entity.AttachmentPath;
        _newFile = null;
        _newFileName = null;

        _statusMessage = "Cambios guardados correctamente.";
        _saving = false;
    }

    private void BackToList()
    {
        Navigation.NavigateTo("/admin/solicitudes");
    }

    private void OnFileChange(InputFileChangeEventArgs e)
    {
        _newFile = e.File;
        _newFileName = e.File.Name;
    }

    private string GetStatusBadgeClass(ArticleStatus status)
    {
        return status switch
        {
            ArticleStatus.Aprobado => "bg-success",
            ArticleStatus.Rechazado => "bg-danger",
            ArticleStatus.Pendiente => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }

    private sealed class EditArticleModel
    {
        public int Id { get; set; }

        [Required]
        [StringLength(200)]
        public string Title { get; set; } = "";

        [Required]
        [MinLength(20)]
        public string Content { get; set; } = "";

        public string AuthorName { get; set; } = "";
        public string AuthorEmail { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public string CategoryName { get; set; } = "";
        public ArticleStatus Status { get; set; }
        public string? AttachmentPath { get; set; }
    }
}
